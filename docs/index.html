<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Nextflow training</title>
<link rel="stylesheet" href="./css/crg.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Nextflow training <span class="image right titlelogo"><img src="./assets/BovReg_logo.jpg" alt="Logo" width="150" height="50"></span></h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_setup">1. Setup</a>
<ul class="sectlevel2">
<li><a href="#_requirements">1.1. Requirements</a></li>
<li><a href="#_launch_the_cloud_environment">1.2. Launch the cloud environment</a>
<ul class="sectlevel3">
<li><a href="#_steps_to_launch_the_aws_9_cloud_environment">1.2.1. Steps to launch the AWS 9 cloud environment</a></li>
</ul>
</li>
<li><a href="#_training_materials_download">1.3. Training materials download</a></li>
<li><a href="#_environment_setup">1.4. Environment setup</a></li>
<li><a href="#_nextflow_installation">1.5. Nextflow Installation</a></li>
</ul>
</li>
<li><a href="#_get_started_with_nextflow">2. Get started with Nextflow</a>
<ul class="sectlevel2">
<li><a href="#_basic_concepts">2.1. Basic concepts</a>
<ul class="sectlevel3">
<li><a href="#_processes_and_channels">2.1.1. Processes and channels</a></li>
<li><a href="#_execution_abstraction">2.1.2. Execution abstraction</a></li>
<li><a href="#_scripting_language">2.1.3. Scripting language</a></li>
</ul>
</li>
<li><a href="#_your_first_script">2.2. Your first script</a></li>
<li><a href="#_modify_and_resume">2.3. Modify and resume</a></li>
<li><a href="#_pipeline_parameters">2.4. Pipeline parameters</a></li>
</ul>
</li>
<li><a href="#_channels">3. Channels</a>
<ul class="sectlevel2">
<li><a href="#_channel_types">3.1. Channel types</a>
<ul class="sectlevel3">
<li><a href="#_queue_channel">3.1.1. Queue channel</a></li>
<li><a href="#_value_channels">3.1.2. Value channels</a></li>
</ul>
</li>
<li><a href="#_channel_factories">3.2. Channel factories</a>
<ul class="sectlevel3">
<li><a href="#_value">3.2.1. value</a></li>
<li><a href="#_from">3.2.2. from</a></li>
<li><a href="#_of">3.2.3. of</a></li>
<li><a href="#_fromlist">3.2.4. fromList</a></li>
<li><a href="#_frompath">3.2.5. fromPath</a></li>
<li><a href="#_fromfilepairs">3.2.6. fromFilePairs</a></li>
<li><a href="#_fromsra">3.2.7. fromSRA</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_processes">4. Processes</a>
<ul class="sectlevel2">
<li><a href="#_script">4.1. Script</a>
<ul class="sectlevel3">
<li><a href="#_script_parameters">4.1.1. Script parameters</a></li>
<li><a href="#_conditional_script">4.1.2. Conditional script</a></li>
</ul>
</li>
<li><a href="#_inputs">4.2. Inputs</a>
<ul class="sectlevel3">
<li><a href="#_input_values">4.2.1. Input values</a></li>
<li><a href="#_input_files">4.2.2. Input files</a></li>
<li><a href="#_input_path">4.2.3. Input path</a></li>
<li><a href="#_combine_input_channels">4.2.4. Combine input channels</a></li>
<li><a href="#_input_repeaters">4.2.5. Input repeaters</a></li>
</ul>
</li>
<li><a href="#_outputs">4.3. Outputs</a>
<ul class="sectlevel3">
<li><a href="#_output_values">4.3.1. Output values</a></li>
<li><a href="#_output_files">4.3.2. Output files</a></li>
<li><a href="#_multiple_output_files">4.3.3. Multiple output files</a></li>
<li><a href="#_dynamic_output_file_names">4.3.4. Dynamic output file names</a></li>
<li><a href="#_composite_inputs_and_outputs">4.3.5. Composite inputs and outputs</a></li>
</ul>
</li>
<li><a href="#_when">4.4. When</a></li>
<li><a href="#_directives">4.5. Directives</a>
<ul class="sectlevel4">
<li><a href="#_exercise_10">Exercise</a></li>
</ul>
</li>
<li><a href="#_organise_outputs">4.6. Organise outputs</a>
<ul class="sectlevel3">
<li><a href="#_publishdir_directive">4.6.1. PublishDir directive</a></li>
<li><a href="#_manage_semantic_sub_directories">4.6.2. Manage semantic sub-directories</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_operators">5. Operators</a>
<ul class="sectlevel2">
<li><a href="#_basic_example">5.1. Basic example</a></li>
<li><a href="#_basic_operators">5.2. Basic operators</a>
<ul class="sectlevel3">
<li><a href="#_view">5.2.1. view</a></li>
<li><a href="#_map">5.2.2. map</a></li>
<li><a href="#_into">5.2.3. into</a></li>
<li><a href="#_mix">5.2.4. mix</a></li>
<li><a href="#_flatten">5.2.5. flatten</a></li>
<li><a href="#_collect">5.2.6. collect</a></li>
<li><a href="#_grouptuple">5.2.7. groupTuple</a></li>
<li><a href="#_join">5.2.8. join</a></li>
<li><a href="#_branch">5.2.9. branch</a></li>
</ul>
</li>
<li><a href="#_more_resources">5.3. More resources</a></li>
</ul>
</li>
<li><a href="#_groovy_basic_structures_and_idioms">6. Groovy basic structures and idioms</a>
<ul class="sectlevel2">
<li><a href="#_printing_values">6.1. Printing values</a></li>
<li><a href="#_comments">6.2. Comments</a></li>
<li><a href="#_variables">6.3. Variables</a></li>
<li><a href="#_lists">6.4. Lists</a></li>
<li><a href="#_maps">6.5. Maps</a></li>
<li><a href="#_string_interpolation">6.6. String interpolation</a></li>
<li><a href="#_multi_line_strings">6.7. Multi-line strings</a></li>
<li><a href="#_if_statement">6.8. If statement</a></li>
<li><a href="#_for_statement">6.9. For statement</a></li>
<li><a href="#_functions">6.10. Functions</a></li>
<li><a href="#_closures">6.11. Closures</a></li>
<li><a href="#_more_resources_2">6.12. More resources</a></li>
</ul>
</li>
<li><a href="#_simple_rna_seq_pipeline">7. Simple Rna-Seq pipeline</a>
<ul class="sectlevel2">
<li><a href="#_define_the_pipeline_parameters">7.1. Define the pipeline parameters</a>
<ul class="sectlevel3">
<li><a href="#_exercise_13">7.1.1. Exercise</a></li>
<li><a href="#_exercise_14">7.1.2. Exercise</a></li>
<li><a href="#_recap">7.1.3. Recap</a></li>
</ul>
</li>
<li><a href="#_create_transcriptome_index_file">7.2. Create transcriptome index file</a>
<ul class="sectlevel3">
<li><a href="#_exercise_15">7.2.1. Exercise</a></li>
<li><a href="#_exercise_16">7.2.2. Exercise</a></li>
<li><a href="#_exercise_17">7.2.3. Exercise</a></li>
<li><a href="#_recap_2">7.2.4. Recap</a></li>
</ul>
</li>
<li><a href="#_collect_read_files_by_pairs">7.3. Collect read files by pairs</a>
<ul class="sectlevel3">
<li><a href="#_exercise_18">7.3.1. Exercise</a></li>
<li><a href="#_exercise_19">7.3.2. Exercise</a></li>
<li><a href="#_recap_3">7.3.3. Recap</a></li>
</ul>
</li>
<li><a href="#_perform_expression_quantification">7.4. Perform expression quantification</a>
<ul class="sectlevel3">
<li><a href="#_exercise_20">7.4.1. Exercise</a></li>
<li><a href="#_exercise_21">7.4.2. Exercise</a></li>
<li><a href="#_recap_4">7.4.3. Recap</a></li>
</ul>
</li>
<li><a href="#_quality_control">7.5. Quality control</a>
<ul class="sectlevel3">
<li><a href="#_exercise_22">7.5.1. Exercise</a></li>
<li><a href="#_recap_5">7.5.2. Recap</a></li>
</ul>
</li>
<li><a href="#_multiqc_report">7.6. MultiQC report</a>
<ul class="sectlevel3">
<li><a href="#_recap_6">7.6.1. Recap</a></li>
</ul>
</li>
<li><a href="#_handle_completion_event">7.7. Handle completion event</a></li>
<li><a href="#_custom_scripts">7.8. Custom scripts</a>
<ul class="sectlevel3">
<li><a href="#_recap_7">7.8.1. Recap</a></li>
</ul>
</li>
<li><a href="#_metrics_and_reports">7.9. Metrics and reports</a></li>
<li><a href="#_mail_notification">7.10. Mail notification</a></li>
<li><a href="#_run_a_project_from_github">7.11. Run a project from GitHub</a></li>
<li><a href="#_more_resources_3">7.12. More resources</a></li>
</ul>
</li>
<li><a href="#_manage_dependencies_containers">8. Manage dependencies &amp; containers</a>
<ul class="sectlevel2">
<li><a href="#_docker_hands_on">8.1. Docker hands-on</a>
<ul class="sectlevel3">
<li><a href="#_run_a_container">8.1.1. Run a container</a></li>
<li><a href="#_pull_a_container">8.1.2. Pull a container</a></li>
<li><a href="#_run_a_container_in_interactive_mode">8.1.3. Run a container in interactive mode</a></li>
<li><a href="#_your_first_dockerfile">8.1.4. Your first Dockerfile</a></li>
<li><a href="#_build_the_image">8.1.5. Build the image</a></li>
<li><a href="#_add_a_software_package_to_the_image">8.1.6. Add a software package to the image</a></li>
<li><a href="#_run_salmon_in_the_container">8.1.7. Run Salmon in the container</a></li>
<li><a href="#_file_system_mounts">8.1.8. File system mounts</a></li>
<li><a href="#_upload_the_container_in_the_docker_hub_bonus">8.1.9. Upload the container in the Docker Hub (bonus)</a></li>
<li><a href="#_run_a_nextflow_script_using_a_docker_container">8.1.10. Run a Nextflow script using a Docker container</a></li>
</ul>
</li>
<li><a href="#_singularity">8.2. Singularity</a>
<ul class="sectlevel3">
<li><a href="#_create_a_singularity_image">8.2.1. Create a Singularity image</a></li>
<li><a href="#_running_a_container">8.2.2. Running a container</a></li>
<li><a href="#_import_a_docker_image">8.2.3. Import a Docker image</a></li>
<li><a href="#_run_a_nextflow_script_using_a_singularity_container">8.2.4. Run a Nextflow script using a Singularity container</a></li>
<li><a href="#_the_singularity_container_library">8.2.5. The Singularity Container Library</a></li>
<li><a href="#_condabioconda_packages">8.2.6. Conda/Bioconda packages</a></li>
<li><a href="#_bonus_exercise">8.2.7. Bonus Exercise</a></li>
<li><a href="#_biocontainers">8.2.8. BioContainers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_configuration_file">9. Configuration file</a>
<ul class="sectlevel2">
<li><a href="#_config_syntax">9.1. Config syntax</a></li>
<li><a href="#_config_variables">9.2. Config variables</a></li>
<li><a href="#_config_comments">9.3. Config comments</a></li>
<li><a href="#_config_scopes">9.4. Config scopes</a></li>
<li><a href="#_config_params">9.5. Config params</a>
<ul class="sectlevel4">
<li><a href="#_exercise_24">Exercise</a></li>
</ul>
</li>
<li><a href="#_config_env">9.6. Config env</a>
<ul class="sectlevel4">
<li><a href="#_exercise_25">Exercise</a></li>
</ul>
</li>
<li><a href="#_config_process">9.7. Config process</a>
<ul class="sectlevel3">
<li><a href="#_config_docker_execution">9.7.1. Config Docker execution</a></li>
<li><a href="#_config_singularity_execution">9.7.2. Config Singularity execution</a></li>
</ul>
</li>
<li><a href="#_config_conda_execution">9.8. Config Conda execution</a></li>
</ul>
</li>
<li><a href="#_deployment_scenarios">10. Deployment scenarios</a>
<ul class="sectlevel2">
<li><a href="#_cluster_deployment">10.1. Cluster deployment</a></li>
<li><a href="#_managing_cluster_resources">10.2. Managing cluster resources</a>
<ul class="sectlevel3">
<li><a href="#_workflow_wide_resources">10.2.1. Workflow wide resources</a></li>
<li><a href="#_configure_process_by_name">10.2.2. Configure process by name</a></li>
<li><a href="#_configure_process_by_labels">10.2.3. Configure process by labels</a></li>
<li><a href="#_configure_multiple_containers">10.2.4. Configure multiple containers</a></li>
</ul>
</li>
<li><a href="#_configuration_profiles">10.3. Configuration profiles</a></li>
<li><a href="#_cloud_deployment">10.4. Cloud deployment</a></li>
<li><a href="#_volume_mounts">10.5. Volume mounts</a></li>
<li><a href="#_custom_job_definition">10.6. Custom job definition</a></li>
<li><a href="#_custom_image">10.7. Custom image</a></li>
<li><a href="#_launch_template">10.8. Launch template</a></li>
<li><a href="#_hybrid_deployments">10.9. Hybrid deployments</a></li>
</ul>
</li>
<li><a href="#_execution_cache_and_resume">11. Execution cache and resume</a>
<ul class="sectlevel2">
<li><a href="#_how_to_resume_works">11.1. How to resume works</a></li>
<li><a href="#_work_directory">11.2. Work directory</a></li>
<li><a href="#_how_to_organize_in_silico_experiments">11.3. How to organize in silico experiments</a></li>
<li><a href="#_execution_provenance">11.4. Execution provenance</a></li>
<li><a href="#_resume_troubleshooting">11.5. Resume troubleshooting</a></li>
</ul>
</li>
<li><a href="#_errors_handling_troubleshooting">12. Errors handling &amp; troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#_execution_errors_debugging">12.1. Execution errors debugging</a></li>
<li><a href="#_ignore_errors">12.2. Ignore errors</a></li>
<li><a href="#_automatic_error_fail_over">12.3. Automatic error fail-over</a></li>
<li><a href="#_retry_with_backoff">12.4. Retry with backoff</a></li>
<li><a href="#_dynamic_resources_allocation">12.5. Dynamic resources allocation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is the documentation for the Nextflow online tutorial that will take place on the framework of the 'Reproducible genomics workflows using Nextflow and nf-core' workshop organized by BovReg and the CRG.</p>
</div>
<div class="paragraph">
<p>The aim of this guide is to cover a vast part of Nextflow features ranging from basic to advanced language aspects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup">1. Setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_requirements">1.1. Requirements</h3>
<div class="paragraph">
<p>Nextflow can be used on any POSIX compatible system (Linux, OS X, etc).
It requires Bash and
<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java
8 (or later)</a> to be installed.</p>
</div>
<div class="paragraph">
<p>Optional requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.docker.com/">Docker</a> engine 1.10.x (or later)</p>
</li>
<li>
<p><a href="https://github.com/sylabs/singularity">Singularity</a> 2.5.x (or later, optional)</p>
</li>
<li>
<p><a href="https://conda.io/">Conda</a> 4.5 (or later, optional)</p>
</li>
<li>
<p><a href="http://www.graphviz.org/">Graphviz</a> (optional)</p>
</li>
<li>
<p><a href="https://aws.amazon.com/cli/">AWS CLI</a> (optional)</p>
</li>
<li>
<p><a href="https://aws.amazon.com/cloud9/">AWS Cloud 9</a> environment properly configured (optional)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_launch_the_cloud_environment">1.2. Launch the cloud environment</h3>
<div class="paragraph">
<p>For this tutorial, we will use the <a href="https://aws.amazon.com/es/cloud9/">AWS Cloud 9</a> virtual environment.</p>
</div>
<div class="paragraph">
<p>To launch the environment, you just need to sign in the AWS console with the <a href="https://www.crg.eu/en/cedric_notredame">CBCRG</a> account and specify
your (first) name as the IAM user. Below we included the list with all the users name created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Acloque</p>
</li>
<li>
<p>Akshatha</p>
</li>
<li>
<p>Alessio</p>
</li>
<li>
<p>Andreia</p>
</li>
<li>
<p>Bala-Kiran</p>
</li>
<li>
<p>Bardou</p>
</li>
<li>
<p>Bjoern</p>
</li>
<li>
<p>Bouabid</p>
</li>
<li>
<p>Brenda-Murdoch</p>
</li>
<li>
<p>Cervin</p>
</li>
<li>
<p>Christiana</p>
</li>
<li>
<p>Daniel</p>
</li>
<li>
<p>Frieder</p>
</li>
<li>
<p>Gabriel</p>
</li>
<li>
<p>Jani</p>
</li>
<li>
<p>Joana</p>
</li>
<li>
<p>Jos</p>
</li>
<li>
<p>Juan-Andres</p>
</li>
<li>
<p>Juliana-Menezes</p>
</li>
<li>
<p>Klopp</p>
</li>
<li>
<p>Kylie-Munyard</p>
</li>
<li>
<p>Laide-Abbas</p>
</li>
<li>
<p>Lucio</p>
</li>
<li>
<p>Maria</p>
</li>
<li>
<p>Mathieu</p>
</li>
<li>
<p>Meenu</p>
</li>
<li>
<p>Mohammad-Hossein</p>
</li>
<li>
<p>Pedro</p>
</li>
<li>
<p>Phanindra-Balaji</p>
</li>
<li>
<p>Praveen-Krishna</p>
</li>
<li>
<p>Sarah</p>
</li>
<li>
<p>Siddharth-Jayaraman</p>
</li>
<li>
<p>Sylvain</p>
</li>
<li>
<p>Tuan</p>
</li>
<li>
<p>Wellison-Jarles</p>
</li>
<li>
<p>Yu</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_steps_to_launch_the_aws_9_cloud_environment">1.2.1. Steps to launch the AWS 9 cloud environment</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open this address on your browser: <a href="https://eu-west-1.console.aws.amazon.com/cloud9/home">eu-west-1.console.aws.amazon.com/cloud9/home</a></p>
</li>
<li>
<p>Once you are in the AWS login page, select <strong>IAM USER</strong> and please fill the credentials below:</p>
<div class="ulist">
<ul>
<li>
<p>Account ID: <strong>885800555707</strong></p>
</li>
<li>
<p>IAM user name: (your username as listed above)</p>
</li>
<li>
<p>password: provided by the organization</p>
</li>
</ul>
</div>
</li>
<li>
<p>When you access the AWS Cloud main page you will find your environment listed in the home page, just click on the <strong>Open IDE</strong> button and
your environment will be launched.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_training_materials_download">1.3. Training materials download</h3>
<div class="paragraph">
<p>Once you <a href="#Steps-to-launch-the-AWS-9-cloud-environment">launched the environment</a>, download the training materials running the command below
on the terminal window that you will find at the botton of the page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="BASH">aws s3 sync s3://cbcrg-eu/nf-training-bovreg .</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don’t miss the ending dot in the above command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We recommend to follow this tutorial using the AWS Cloud 9 environment. However, if you want to use your machine you can
alsodownload all the materials using <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="BASH">curl https://cbcrg-eu.s3-eu-west-1.amazonaws.com/nf-training-bovreg/nf-training-bovreg.tar.gz | tar xvz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or alternatively if you have <code>wget</code> instead of <code>curl</code> in your machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="BASH">wget -q -O- https://cbcrg-eu.s3-eu-west-1.amazonaws.com/nf-training-bovreg/nf-training-bovreg.tar.gz | tar xvz</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_environment_setup">1.4. Environment setup</h3>
<div class="paragraph">
<p>To complete the environment setup you just need to run the script below, which installs Java an other requirements for this tutorial.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="BASH">source setup/all.sh</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nextflow_installation">1.5. Nextflow Installation</h3>
<div class="paragraph">
<p>Install the latest version of Nextflow copy &amp; pasting the following snippet in a terminal window:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="BASH">curl https://get.nextflow.io | bash
mv nextflow ~/bin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the correct installation running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="BASH">nextflow info</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_started_with_nextflow">2. Get started with Nextflow</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basic_concepts">2.1. Basic concepts</h3>
<div class="paragraph">
<p>Nextflow is workflow orchestration engine and a programming domain specific language (DSL) that eases the writing of data-intensive computational pipelines.</p>
</div>
<div class="paragraph">
<p>It is designed around the idea that the Linux platform is the lingua franca of data science. Linux provides many simple but powerful command-line and scripting tools that, when chained together, facilitate complex data manipulations.</p>
</div>
<div class="paragraph">
<p>Nextflow extends this approach, adding the ability to define complex program interactions and a high-level parallel computational environment based on the dataflow programming model. Nextflow core features are:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>enable workflows portability &amp; reproducibility</p>
</li>
<li>
<p>simplify parallelization and large scale deployment</p>
</li>
<li>
<p>easily integrate existing tools, systems &amp; industry standards</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_processes_and_channels">2.1.1. Processes and channels</h4>
<div class="paragraph">
<p>In practice a Nextflow pipeline script is made by joining together different processes. Each process can be written in any scripting language
that can be executed by the Linux platform (Bash, Perl, Ruby, Python, etc.).</p>
</div>
<div class="paragraph">
<p>Processes are executed independently and are isolated from each other, i.e. they do not share a common (writable) state. The only way they can
communicate is via asynchronous FIFO queues, called channels in Nextflow.</p>
</div>
<div class="paragraph">
<p>Any process can define one or more channels as input and output. The interaction between these processes, and ultimately the pipeline execution
flow itself, is implicitly defined by these input and output declarations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_execution_abstraction">2.1.2. Execution abstraction</h4>
<div class="paragraph">
<p>While a process defines what command or script has to be executed, the executor determines how that script is actually run in the target system.</p>
</div>
<div class="paragraph">
<p>If not otherwise specified, processes are executed on the local computer. The local executor is very useful for pipeline development and testing
purposes, but for real world computational pipelines an HPC or cloud platform is often required.</p>
</div>
<div class="paragraph">
<p>In other words, Nextflow provides an abstraction between the pipeline’s functional logic and the underlying execution system. Thus it is possible
to write a pipeline once and to seamlessly run it on your computer, a grid platform, or the cloud, without modifying it, by simply defining the
target execution platform in the configuration file.</p>
</div>
<div class="paragraph">
<p>It provides out-of-the-box support for major batch schedulers and cloud platforms:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Grid engine (Open/Sun/Univa)</p>
</li>
<li>
<p>IBM Platform LSF</p>
</li>
<li>
<p>Linux SLURM</p>
</li>
<li>
<p>PBS Works</p>
</li>
<li>
<p>Torque</p>
</li>
<li>
<p>Moab</p>
</li>
<li>
<p>HTCondor</p>
</li>
<li>
<p>Amazon Batch</p>
</li>
<li>
<p>Google Life Sciences</p>
</li>
<li>
<p>Kubernetes</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_scripting_language">2.1.3. Scripting language</h4>
<div class="paragraph">
<p>Nextflow implements declarative domain specific language (DSL) simplifies the writing of writing complex data analysis workflows as an extension of
a general purpose programming language.</p>
</div>
<div class="paragraph">
<p>This approach makes Nextflow very flexible because allows to have in the same computing environment the benefit of concise DSL that allow the
handling of recurrent use cases with ease <strong>and</strong> the flexibility and power of a general purpose programming language to handle corner cases, which
may be difficult to implement using a declarative approach.</p>
</div>
<div class="paragraph">
<p>In practical terms Nextflow scripting is an extension of the <a href="https://groovy-lang.org/">Groovy programming language</a>, which in turn is a super-set of the Java programming
language. Groovy can be considered as Python for Java in that is simplifies the writing of code and is more approachable.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_your_first_script">2.2. Your first script</h3>
<div class="paragraph">
<p>Copy the following example into your favourite text editor and save it to a file named <code>hello.nf</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">#!/usr/bin/env nextflow

params.greeting  = 'Hello world!'
greeting_ch = Channel.from(params.greeting)

process splitLetters {

    input:
    val x from greeting_ch

    output:
    file 'chunk_*' into letters

    """
    printf '$x' | split -b 6 - chunk_
    """
}

process convertToUpper {

    input:
    file y from letters.flatten()

    output:
    stdout into result

    """
    cat $y | tr '[a-z]' '[A-Z]'
    """
}

result.view{ it.trim() }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script defines two processes. The first splits a string into files containing chunks of 6 characters. The second receives these files and transforms their
contents to uppercase letters. The resulting strings are emitted on the <code>result</code> channel and the final output is printed by the <code>view</code> operator.</p>
</div>
<div class="paragraph">
<p>Execute the script by entering the following command in your terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run hello.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will output something similar to the text shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">N E X T F L O W  ~  version 20.10.0
Launching `hello.nf` [infallible_wilson] - revision: db17b351c4
executor &gt;  local (3)
[ca/361e5c] process &gt; splitLetters (1)   [100%] 1 of 1 ✔
[5a/44a867] process &gt; convertToUpper (1) [100%] 2 of 2 ✔
HELLO
WORLD!</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the first process is executed once, and the second twice. Finally the result string is printed.</p>
</div>
<div class="paragraph">
<p>It’s worth noting that the process <code>convertToUpper</code> is executed in parallel, so there’s no guarantee that the instance
processing the first split (the chunk Hello) will be executed before the one processing the second split (the chunk world!).</p>
</div>
<div class="paragraph">
<p>Thus, it is perfectly possible that you will get the final result printed out in a different order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">WORLD!
HELLO</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The hexadecimal numbers, like <code>ca/361e5c</code>, identify the unique process execution. These numbers are also the prefix of the directories
where each process is executed. You can inspect the files produced by them changing to the directory <code>$PWD/work</code> and using these
numbers to find the process-specific execution path.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_modify_and_resume">2.3. Modify and resume</h3>
<div class="paragraph">
<p>Nextflow keeps track of all the processes executed in your pipeline. If you modify some parts of your script, only the processes that
are actually changed will be re-executed. The execution of the processes that are not changed will be skipped and the cached result
used instead.</p>
</div>
<div class="paragraph">
<p>This helps a lot when testing or modifying part of your pipeline without having to re-execute it from scratch.</p>
</div>
<div class="paragraph">
<p>For the sake of this tutorial, modify the convertToUpper process in the previous example, replacing the process script with the string
<code>rev $y</code>, so that the process looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">process convertToUpper {

    input:
    file y from letters.flatten()

    output:
    stdout into result

    """
    rev $y
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then save the file with the same name, and execute it by adding the -resume option to the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run hello.nf -resume</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will print output similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">N E X T F L O W  ~  version 20.10.0
Launching `hello.nf` [gloomy_shockley] - revision: 2a9917d420
executor &gt;  local (2)
[ca/361e5c] process &gt; splitLetters (1)   [100%] 1 of 1, cached: 1 ✔
[56/522eae] process &gt; convertToUpper (1) [100%] 2 of 2 ✔
olleH
!dlrow</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see that the execution of the process splitLetters is actually skipped (the process ID is the same), and its
results are retrieved from the cache. The second process is executed as expected, printing the reversed strings.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The pipeline results are cached by default in the directory $PWD/work. Depending on your script, this folder can take
of lot of disk space. If your are sure you won’t resume your pipeline execution, clean this folder periodically.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_pipeline_parameters">2.4. Pipeline parameters</h3>
<div class="paragraph">
<p>Pipeline parameters are simply declared by prepending to a variable name the prefix <code>params</code>, separated by dot character.
Their value can be specified on the command line by prefixing the parameter name with a double dash character, i.e.
<code>--paramName</code></p>
</div>
<div class="paragraph">
<p>For the sake of this tutorial, you can try to execute the previous example specifying a different input string parameter,
as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run hello.nf --greeting 'Bonjour le monde!'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The string specified on the command line will override the default value of the parameter. The output will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">N E X T F L O W  ~  version 20.10.0
Launching `hello.nf` [distracted_hilbert] - revision: 2a9917d420
executor &gt;  local (4)
[82/18a151] process &gt; splitLetters (1)   [100%] 1 of 1 ✔
[a5/189102] process &gt; convertToUpper (1) [100%] 3 of 3 ✔
uojnoB
m el r
!edno</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_channels">3. Channels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Channels are a key data structure of Nextflow that allows the implementation of reactive-functional oriented computational
workflows based on the <a href="https://en.wikipedia.org/wiki/Dataflow_programming">Dataflow</a> programming paradigm.</p>
</div>
<div class="paragraph">
<p>They are used to logically connect tasks each other or to implement functional style data transformations.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./assets/channel-files.png" alt="channel files">
</div>
</div>
<div class="sect2">
<h3 id="_channel_types">3.1. Channel types</h3>
<div class="paragraph">
<p>Nextflow distinguish two different kinds of channels: <strong>queue</strong> channels and <strong>value</strong> channels.</p>
</div>
<div class="sect3">
<h4 id="_queue_channel">3.1.1. Queue channel</h4>
<div class="paragraph">
<p>A queue channel is a asynchronous unidirectional <a href="https://en.wikipedia.org/wiki/FIFO_(computing_and_electronics)">FIFO</a>
queue which connects two processes or operators.</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>What asynchronous means? That operations are non-blocking.</p>
</li>
<li>
<p>What unidirectional means? That data flow from a producer to a consumer.</p>
</li>
<li>
<p>What FIFO means? That the data is guaranteed to be delivered in the same order as it is produced.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A queue channel is implicitly created by process output definitions or using channel factories methods
such as <a href="https://www.nextflow.io/docs/latest/channel.html#from">Channel.from</a> or <a href="https://www.nextflow.io/docs/latest/channel.html#frompath">Channel.fromPath</a>.</p>
</div>
<div class="paragraph">
<p>Try the following snippets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">ch = Channel.from(1,2,3)
println(ch)     <i class="conum" data-value="1"></i><b>(1)</b>
ch.view()       <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the built-in println function to print the ch variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Apply the view method to the ch channel, therefore prints each item emitted by the channels.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise">Exercise</h5>
<div class="paragraph">
<p>Try to execute this snippet, it will produce an error message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">p = Channel.from(1,2,3)
p.view()
p.view()</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A queue channel can have one and exactly one producer and one and exactly one consumer.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_value_channels">3.1.2. Value channels</h4>
<div class="paragraph">
<p>A <strong>value</strong> channel a.k.a. singleton channel by definition is bound to a single value and it can be read unlimited times without consuming its content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">ch = Channel.value('Hello')
ch.view()
ch.view()
ch.view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Hello
Hello
Hello</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_channel_factories">3.2. Channel factories</h3>
<div class="sect3">
<h4 id="_value">3.2.1. value</h4>
<div class="paragraph">
<p>The <code>value</code> factory method is used to create a <em>value</em> channel. An optional not <code>null</code> argument
can be specified to bind the channel to a specific value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">ch1 = Channel.value()                 <i class="conum" data-value="1"></i><b>(1)</b>
ch2 = Channel.value( 'Hello there' )  <i class="conum" data-value="2"></i><b>(2)</b>
ch2 = Channel.value( [1,2,3,4,5] )    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates an <em>empty</em> value channel.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates a value channel and binds a string to it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates a value channel and binds a list object to it that will be emitted as a sole emission.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_from">3.2.2. from</h4>
<div class="paragraph">
<p>The factory <code>Channel.from</code> allows the creation of a queue channel with the values specified as argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">ch = Channel.from( 1, 3, 5, 7 )
ch.view{ "value: $it" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line in this example creates a variable <code>ch</code> which holds a channel object. This channel emits the values specified as a parameter in the <code>from</code> method. Thus the second line will print the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>value: 1
value: 3
value: 5
value: 7</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Method <code>Channel.from</code> will be deprecated and replaced by <code>Channel.of</code> (see below)
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_of">3.2.3. of</h4>
<div class="paragraph">
<p>The method <code>Channel.of</code> works in a similar manner to <code>Channel.from</code>, though it fixes some inconsistent behavior of the latter and provides a better handling for range of values. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .of(1..23, 'X', 'Y')
    .view()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fromlist">3.2.4. fromList</h4>
<div class="paragraph">
<p>The method <code>Channel.fromList</code> creates a channel emitting the elements provided by a list objects specified as argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">list = ['hello', 'world']

Channel
    .fromList(list)
    .view()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_frompath">3.2.5. fromPath</h4>
<div class="paragraph">
<p>The <code>fromPath</code> factory method create a queue channel emitting one or more files
matching the specified glob pattern.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel.fromPath( '/data/big/*.txt' )</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example creates a channel and emits as many items as there are files with <code>txt</code> extension in the <code>/data/big</code> folder. Each element is a file object implementing the <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Paths.html">Path</a> interface.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Two asterisks, i.e. <code>**</code>, works like <code>*</code> but crosses directory boundaries. This syntax is generally used for matching complete paths. Curly brackets specify a collection of sub-patterns.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Available options</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">glob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> interprets characters <code>*</code>, <code>?</code>, <code>[]</code> and <code>{}</code> as glob wildcards, otherwise handles them as normal characters (default: <code>true</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of paths returned, either <code>file</code>, <code>dir</code> or <code>any</code> (default: <code>file</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> includes hidden files in the resulting paths (default: <code>false</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxDepth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of directory levels to visit (default: <code>no limit</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">followLinks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> it follows symbolic links during directories tree traversal, otherwise they are managed as files (default: <code>true</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">relative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> returned paths are relative to the top-most common directory (default: <code>false</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> throws an exception of the specified path do not exist in the file system (default: <code>false</code>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Learn more about the blog pattern syntax at <a href="https://docs.oracle.com/javase/tutorial/essential/io/fileOps.html#glob">this link</a>.</p>
</div>
<div class="sect4">
<h5 id="_exercise_2">Exercise</h5>
<div class="paragraph">
<p>Use the <code>Channel.fromPath</code> method to create a channel emitting all files with the suffix <code>.fq</code> in the <code>data/ggal/</code> and any subdirectory, then print the file name.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fromfilepairs">3.2.6. fromFilePairs</h4>
<div class="paragraph">
<p>The <code>fromFilePairs</code> method creates a channel emitting the file pairs matching a glob pattern provided by the user. The matching files are emitted as tuples in which the first element is the grouping key of the matching pair and the second element is the list of files (sorted in lexicographical order).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .fromFilePairs('/my/data/SRR*_{1,2}.fastq')
    .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will produce an output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[SRR493366, [/my/data/SRR493366_1.fastq, /my/data/SRR493366_2.fastq]]
[SRR493367, [/my/data/SRR493367_1.fastq, /my/data/SRR493367_2.fastq]]
[SRR493368, [/my/data/SRR493368_1.fastq, /my/data/SRR493368_2.fastq]]
[SRR493369, [/my/data/SRR493369_1.fastq, /my/data/SRR493369_2.fastq]]
[SRR493370, [/my/data/SRR493370_1.fastq, /my/data/SRR493370_2.fastq]]
[SRR493371, [/my/data/SRR493371_1.fastq, /my/data/SRR493371_2.fastq]]</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The glob pattern must contain at least a star wildcard character.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Available options</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of paths returned, either <code>file</code>, <code>dir</code> or <code>any</code> (default: <code>file</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> includes hidden files in the resulting paths (default: <code>false</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxDepth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of directory levels to visit (default: <code>no limit</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">followLinks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> it follows symbolic links during directories tree traversal, otherwise they are managed as files (default: <code>true</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the number of files each emitted item is expected to hold (default: 2). Set to <code>-1</code> for any.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> the matching files are produced as sole elements in the emitted tuples (default: <code>false</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> throws an exception of the specified path do not exist in the file system (default: <code>false</code>)</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_exercise_3">Exercise</h5>
<div class="paragraph">
<p>Use the <code>fromFilePairs</code> method to create a channel emitting all pairs of fastq read in the <code>data/ggal/</code>
directory and print them.</p>
</div>
<div class="paragraph">
<p>Then use the <code>flat:true</code> option and compare the output with the previous execution.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fromsra">3.2.7. fromSRA</h4>
<div class="paragraph">
<p>The <code>Channel.fromSRA</code> method that makes it possible to query of NCBI SRA archive and returns a channel emitting the FASTQ files matching the specified selection criteria.</p>
</div>
<div class="paragraph">
<p>The query can be project ID or accession number(s) supported by the NCBI ESearch API. For example the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .fromSRA('SRP043510')
    .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">[SRR1448794, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/004/SRR1448794/SRR1448794.fastq.gz]
[SRR1448795, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/005/SRR1448795/SRR1448795.fastq.gz]
[SRR1448792, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/002/SRR1448792/SRR1448792.fastq.gz]
[SRR1448793, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/003/SRR1448793/SRR1448793.fastq.gz]
[SRR1910483, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR191/003/SRR1910483/SRR1910483.fastq.gz]
[SRR1910482, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR191/002/SRR1910482/SRR1910482.fastq.gz]
(remaining omitted)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple accession IDs can be specified using a list object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">ids = ['ERR908507', 'ERR908506', 'ERR908505']
Channel
    .fromSRA(ids)
    .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Results in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">[ERR908507, [ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908507/ERR908507_1.fastq.gz, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908507/ERR908507_2.fastq.gz]]
[ERR908506, [ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908506/ERR908506_1.fastq.gz, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908506/ERR908506_2.fastq.gz]]
[ERR908505, [ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908505/ERR908505_1.fastq.gz, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908505/ERR908505_2.fastq.gz]]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Read pairs are implicitly managed are returned as a list of files.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It’s straightforward to use this channel as an input using the usual Nextflow syntax. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.accession = 'SRP043510'
reads = Channel.fromSRA(params.accession)

process fastqc {
    input:
    tuple sample_id, file(reads_file) from reads

    output:
    file("fastqc_${sample_id}_logs") into fastqc_ch

    script:
    """
    mkdir fastqc_${sample_id}_logs
    fastqc -o fastqc_${sample_id}_logs -f fastq -q ${reads_file}
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code snippet above creates a channel containing 24 samples from a chromatin dynamics study and runs FASTQC on the resulting files.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processes">4. Processes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>process</em> is the basic Nextflow computing primitive to execute foreign function i.e. custom
scripts or tools.</p>
</div>
<div class="paragraph">
<p>The process definition starts with keyword the <code>process</code>, followed by process name and finally the process <code>body</code> delimited by curly brackets. The process body must contain a string which represents the command or, more generally, a script that is executed by it.</p>
</div>
<div class="paragraph">
<p>A basic process looks like the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process sayHello {
  """
  echo 'Hello world!'
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A process may contain five definition blocks, respectively: directives,
inputs, outputs, when clause and finally the process script. The syntax is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>process &lt; name &gt; {
  [ directives ]        <i class="conum" data-value="1"></i><b>(1)</b>
  input:                <i class="conum" data-value="2"></i><b>(2)</b>
  &lt; process inputs &gt;
  output:               <i class="conum" data-value="3"></i><b>(3)</b>
  &lt; process outputs &gt;
  when:                 <i class="conum" data-value="4"></i><b>(4)</b>
  &lt; condition &gt;
  [script|shell|exec]:  <i class="conum" data-value="5"></i><b>(5)</b>
  &lt; user script to be executed &gt;
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Zero, one or more process directives</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Zero, one or more process inputs</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Zero, one or more process outputs</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>An optional boolean conditional to trigger the process execution</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The command to be executed</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_script">4.1. Script</h3>
<div class="paragraph">
<p>The <code>script</code> block is a string statement that defines the command that is executed by the process to carry out its task.</p>
</div>
<div class="paragraph">
<p>A process contains one and only one script block, and it must be the last statement when the process contains input and output declarations.</p>
</div>
<div class="paragraph">
<p>The script block can be a simple string or multi-line string. The latter simplifies the writing of non trivial scripts
composed by multiple commands spanning over multiple lines. For example::</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process example {
    script:
    """
    blastp -db /data/blast -query query.fa -outfmt 6 &gt; blast_result
    cat blast_result | head -n 10 | cut -f 2 &gt; top_hits
    blastdbcmd -db /data/blast -entry_batch top_hits &gt; sequences
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the process command is interpreted as a <strong>Bash</strong> script. However any other scripting language can be used just simply starting the script with the corresponding <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">Shebang</a> declaration. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process pyStuff {
  script:
  """
  #!/usr/bin/env python

  x = 'Hello'
  y = 'world!'
  print ("%s - %s" % (x,y))
  """
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This allows the compositing in the same workflow script of tasks using different programming languages which may better fit a particular job. However for large chunks of code is suggested to save them
into separate files and invoke them from the process script.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_script_parameters">4.1.1. Script parameters</h4>
<div class="paragraph">
<p>Process script can be defined dynamically using variable values like in other string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.data = 'World'

process foo {
  script:
  """
  echo Hello $params.data
  """
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A process script can contain any string format supported by the Groovy programming language. This allows us to use string
interpolation or multiline string as in the script above. Refer to <a href="#_string_interpolation">String interpolation</a> for more information.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Since Nextflow uses the same Bash syntax for variable substitutions in strings, Bash environment variables need to be escaped using <code>\</code> character.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  script:
  """
  echo "The current directory is \$PWD"
  """
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Try to modify the above script using $PWD instead of \$PWD and check the difference.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This can be tricky when the script uses many Bash variables. A possible alternative
is to use a script string delimited by single-quote characters</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process bar {
  script:
  '''
  echo $PATH | tr : '\\n'
  '''
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However this won&#8217;t allow any more the usage of Nextflow variables in the command script.</p>
</div>
<div class="paragraph">
<p>Another alternative is to use a <code>shell</code> statement instead of <code>script</code> which uses a different
the following syntax for Nextflow variables: <code>!{..}</code>. This allow to use both Nextflow and Bash variables in
the same script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.data = 'le monde'

process baz {
  shell:
  '''
  X='Bonjour'
  echo $X !{params.data}
  '''
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_conditional_script">4.1.2. Conditional script</h4>
<div class="paragraph">
<p>The process script can also be defined in a complete dynamic manner using a <code>if</code> statement or any other expression evaluating to string value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.aligner = 'kallisto'

process foo {
  script:
  if( params.aligner == 'kallisto' )
    """
    kallisto --reads /some/data.fastq
    """
  else if( params.aligner == 'salmon' )
    """
    salmons --reads /some/data.fastq
    """
  else
    throw new IllegalArgumentException("Unknown aligner $params.aligner")
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_4">Exercise</h5>
<div class="paragraph">
<p>Write a custom function that given the aligner name as parameter returns the command
string to be executed. Then use this function as the process script body.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inputs">4.2. Inputs</h3>
<div class="paragraph">
<p>Nextflow processes are isolated from each other but can communicate between themselves sending values through channels.</p>
</div>
<div class="paragraph">
<p>Inputs implicitly determine the dependency and the parallel execution of the process. The process execution is fired each time a new data is ready to be consumed from the input channel:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./assets/channel-process.png" alt="channel process">
</div>
</div>
<div class="paragraph">
<p>The input block defines which channels the process is expecting to receive inputs data from. You can only define one input block at a time and it must contain one or more inputs declarations.</p>
</div>
<div class="paragraph">
<p>The input block follows the syntax shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">input:
  &lt;input qualifier&gt; &lt;input name&gt; [from &lt;source channel&gt;]</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_input_values">4.2.1. Input values</h4>
<div class="paragraph">
<p>The <code>val</code> qualifier allows you to receive data of any type as input. It can be accessed in the process script by using the specified input name, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">num = Channel.from( 1, 2, 3 )

process basicExample {
  input:
  val x from num

  """
  echo process job $x
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the process is executed three times, each time a value is received from the channel num and used to process the script. Thus, it results in an output similar to the one shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>process job 3
process job 1
process job 2</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The channel guarantees that items are delivered in the same order as they have been sent - but - since the process is executed in a parallel manner, there is no guarantee that they are processed in the same order as they are received.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_input_files">4.2.2. Input files</h4>
<div class="paragraph">
<p>The <code>file</code> qualifier allows the handling of file values in the process execution context. This means that
Nextflow will stage it in the process execution directory, and it can be access in the script by using the name specified in the input declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">reads = Channel.fromPath( 'data/ggal/*.fq' )

process foo {
    input:
    file 'sample.fastq' from reads
    script:
    """
    your_command --reads sample.fastq
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The input file name can also be defined using a variable reference as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">reads = Channel.fromPath( 'data/ggal/*.fq' )

process foo {
    input:
    file sample from reads
    script:
    """
    your_command --reads $sample
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same syntax it&#8217;s also able to handle more than one input file in the same execution.
Only change the channel composition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">reads = Channel.fromPath( 'data/ggal/*.fq' )

process foo {
    input:
    file sample from reads.collect()
    script:
    """
    your_command --reads $sample
    """
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When a process declares an input <code>file</code> the corresponding channel elements must be <strong>file</strong> objects i.e.
created with the <code>file</code> helper function from the file specific channel factories e.g. <code>Channel.fromPath</code> or <code>Channel.fromFilePairs</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.genome = 'data/ggal/transcriptome.fa'

process foo {
    input:
    file genome from params.genome
    script:
    """
    your_command --reads $genome
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code creates a temporary file named input.1 with the string data/ggal/transcriptome.fa as content.
That likely is not what you wanted to do.</p>
</div>
</div>
<div class="sect3">
<h4 id="_input_path">4.2.3. Input path</h4>
<div class="paragraph">
<p>As of version 19.10.0, Nextflow introduced a new <code>path</code> input qualifier that simplifies the handling of cases such as the one shown above.
In a nutshell the input <code>path</code> automatically handles string values as file objects. The following example works as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.genome = "$baseDir/data/ggal/transcriptome.fa"

process foo {
    input:
    path genome from params.genome
    script:
    """
    your_command --reads $genome
    """
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The path qualifier should be preferred over file to handle process input files when using Nextflow 19.10.0 or later.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise_5">Exercise</h5>
<div class="paragraph">
<p>Write a script that creates a channel containing all read files matching the pattern <code>data/ggal/*_1.fq</code> followed by a process
that concatenates them into a single file and prints the first 20 lines.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_combine_input_channels">4.2.4. Combine input channels</h4>
<div class="paragraph">
<p>A key feature of processes is the ability to handle inputs from multiple channels. However it&#8217;s
important to understands how the content of channel and their semantic affect the execution
of a process.</p>
</div>
<div class="paragraph">
<p>Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  echo true
  input:
  val x from Channel.from(1,2,3)
  val y from Channel.from('a','b','c')
  script:
   """
   echo $x and $y
   """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both channels emit three value, therefore the process is executed three times, each time with a different pair:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(1, a)</p>
</li>
<li>
<p>(2, b)</p>
</li>
<li>
<p>(3, c)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What is happening is that the process waits until there&#8217;s a complete input configuration i.e. it receives an input
value from all the channels declared as input.</p>
</div>
<div class="paragraph">
<p>When this condition is verified, it consumes the input values coming from the respective channels, and spawns a
task execution, then repeat the same logic until one or more channels have no more content.</p>
</div>
<div class="paragraph">
<p>This means channel values are consumed serially one after another and the first empty channel cause the process
execution to stop even if there are other values in other channels.</p>
</div>
<div class="paragraph">
<p><strong>What does it happen when not all channels have the same cardinality (i.e. they emit a different number of elements)?</strong></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  echo true
  input:
  val x from Channel.from(1,2)
  val y from Channel.from('a','b','c','d')
  script:
   """
   echo $x and $y
   """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the process is executed only two times, because when a channel has no more data to be processed it stops the process execution.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note however that <em>value</em> channel do not affect the process termination.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To better understand this behavior compare the previous example with the following one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process bar {
  echo true
  input:
  val x from Channel.value(1)
  val y from Channel.from('a','b','c')
  script:
   """
   echo $x and $y
   """
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_6">Exercise</h5>
<div class="paragraph">
<p>Write a process that is executed for each read file matching the pattern <code>data/ggal/*_1.fa</code> and
uses the same <code>data/ggal/transcriptome.fa</code> in each execution.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_input_repeaters">4.2.5. Input repeaters</h4>
<div class="paragraph">
<p>The <code>each</code> qualifier allows you to repeat the execution of a process for each item in a collection, every time a new data is received. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">sequences = Channel.fromPath('data/prots/*.tfa')
methods = ['regular', 'expresso', 'psicoffee']

process alignSequences {
  input:
  file seq from sequences
  each mode from methods

  """
  t_coffee -in $seq -mode $mode
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example every time a file of sequences is received as input by the process, it executes three tasks running a T-coffee alignment with a different value for the <code>mode</code> parameter. This is useful when you need to repeat the same task for a given set of parameters.</p>
</div>
<div class="sect4">
<h5 id="_exercise_7">Exercise</h5>
<div class="paragraph">
<p>Extend the previous example so a task is executed for each read file matching the pattern <code>data/ggal/*_1.fa</code> and repeat the same task both with <code>salmon</code> and <code>kallisto</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_outputs">4.3. Outputs</h3>
<div class="paragraph">
<p>The <em>output</em> declaration block allows to define the channels used by the process to send out the results produced.</p>
</div>
<div class="paragraph">
<p>There can be defined at most one output block and it can contain one or more outputs declarations. The output block follows the syntax shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>output:
  &lt;output qualifier&gt; &lt;output name&gt; [into &lt;target channel&gt;[,channel,..]]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_output_values">4.3.1. Output values</h4>
<div class="paragraph">
<p>The <code>val</code> qualifier allows to output a <em>value</em> defined in the script context. In a common usage scenario,
this is a value which has been defined in the <em>input</em> declaration block, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">methods = ['prot','dna', 'rna']

process foo {
  input:
  val x from methods

  output:
  val x into receiver

  """
  echo $x &gt; file
  """
}

receiver.view { "Received: $it" }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_output_files">4.3.2. Output files</h4>
<div class="paragraph">
<p>The <code>file</code> qualifier allows to output one or more files, produced by the process, over the specified channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process randomNum {

    output:
    file 'result.txt' into numbers

    '''
    echo $RANDOM &gt; result.txt
    '''
}

numbers.view { "Received: " + it.text }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the process <code>randomNum</code> creates a file named <code>result.txt</code> containing a random number.</p>
</div>
<div class="paragraph">
<p>Since a file parameter using the same name is declared in the output block, when the task is completed that
file is sent over the <code>numbers</code> channel. A downstream <code>process</code> declaring the same channel as <em>input</em> will
be able to receive it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_output_files">4.3.3. Multiple output files</h4>
<div class="paragraph">
<p>When an output file name contains a <code>*</code> or <code>?</code> wildcard character it is interpreted as a
<a href="http://docs.oracle.com/javase/tutorial/essential/io/fileOps.html#glob">glob</a> path matcher.
This allows to <em>capture</em> multiple files into a list object and output them as a sole emission. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process splitLetters {

    output:
    file 'chunk_*' into letters

    '''
    printf 'Hola' | split -b 1 - chunk_
    '''
}

letters
    .flatMap()
    .view { "File: ${it.name} =&gt; ${it.text}" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>it prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>File: chunk_aa =&gt; H
File: chunk_ab =&gt; o
File: chunk_ac =&gt; l
File: chunk_ad =&gt; a</pre>
</div>
</div>
<div class="paragraph">
<p>Some caveats on glob pattern behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Input files are not included in the list of possible matches.</p>
</li>
<li>
<p>Glob pattern matches against both files and directories path.</p>
</li>
<li>
<p>When a two stars pattern <code>**</code> is used to recourse across directories, only file paths are matched
i.e. directories are not included in the result list.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_exercise_8">Exercise</h5>
<div class="paragraph">
<p>Remove the <code>flatMap</code> operator and see out the output change. The documentation
for the <code>flatMap</code> operator is available at <a href="https://www.nextflow.io/docs/latest/operator.html#flatmap">this link</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_output_file_names">4.3.4. Dynamic output file names</h4>
<div class="paragraph">
<p>When an output file name needs to be expressed dynamically, it is possible to define it using a dynamic evaluated
string which references values defined in the input declaration block or in the script global context.
For example::</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">sample_ch = Channel.from ('human', 'mouse')

process align {

  input:
  val x from sample_ch

  output:
  file "${x}.txt" into sample_files_ch

  """
  touch ${x}.txt
  """
}

sample_files_ch.view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, each time the process is executed an alignment file is produced whose name depends
on the actual value of the <code>x</code> input.</p>
</div>
</div>
<div class="sect3">
<h4 id="_composite_inputs_and_outputs">4.3.5. Composite inputs and outputs</h4>
<div class="paragraph">
<p>So far we have seen how to declare multiple input and output channels, but each channel was handling
only one value at time. However Nextflow can handle tuple of values.</p>
</div>
<div class="paragraph">
<p>When using channel emitting tuple of values the corresponding input declaration must be declared with a <code>set</code> qualifier followed by definition of each single element in the tuple.</p>
</div>
<div class="paragraph">
<p>In the same manner output channel emitting tuple of values can be declared using the <code>set</code> qualifier
following by the definition of each tuple element in the tuple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">reads_ch = Channel.fromFilePairs('data/ggal/*_{1,2}.fq')

process foo {
  input:
    set val(sample_id), file(sample_files) from reads_ch
  output:
    set val(sample_id), file('sample.bam') into bam_ch
  script:
  """
    your_command_here --reads $sample_id &gt; sample.bam
  """
}

bam_ch.view()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In previous versions of Nextflow <code>tuple</code> was called <code>set</code> but it was used exactly with the same semantic. It can still be used for backward compatibility.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise_9">Exercise</h5>
<div class="paragraph">
<p>Modify the script of the previous exercise so that the <em>bam</em> file is named as the given <code>sample_id</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_when">4.4. When</h3>
<div class="paragraph">
<p>The <code>when</code> declaration allows you to define a condition that must be verified in order to execute the process. This can be any expression that evaluates a boolean value.</p>
</div>
<div class="paragraph">
<p>It is useful to enable/disable the process execution depending the state of various inputs and parameters. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.dbtype = 'nr'
params.prot = 'data/prots/*.tfa'
proteins = Channel.fromPath(params.prot)

process find {
  input:
  file fasta from proteins
  val type from params.dbtype

  when:
  fasta.name =~ /^BB11.*/ &amp;&amp; type == 'nr'

  script:
  """
  blastp -query $fasta -db nr
  """
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_directives">4.5. Directives</h3>
<div class="paragraph">
<p>Directive declarations allow the definition of optional settings that affect the execution of the current process without affecting the <em>semantic</em> of the task itself.</p>
</div>
<div class="paragraph">
<p>They must be entered at the top of the process body, before any other declaration blocks (i.e. <code>input</code>, <code>output</code>, etc).</p>
</div>
<div class="paragraph">
<p>Directives are commonly used to define the amount of computing resources to be used or
other meta directives like that allows the definition of extra information for configuration or
logging purpose. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  cpus 2
  memory 8.GB
  container 'image/name'

  script:
  """
  your_command --this --that
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete list of directives is available <a href="https://www.nextflow.io/docs/latest/process.html#directives">at this link</a>.</p>
</div>
<div class="sect4">
<h5 id="_exercise_10">Exercise</h5>
<div class="paragraph">
<p>Modify the script of the previous exercise adding a <a href="https://www.nextflow.io/docs/latest/process.html#tag">tag</a> directive logging the <code>sample_id</code> in the execution output.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_organise_outputs">4.6. Organise outputs</h3>
<div class="sect3">
<h4 id="_publishdir_directive">4.6.1. PublishDir directive</h4>
<div class="paragraph">
<p>Nextflow manages independently workflow execution intermediate results from the pipeline expected outputs. Task output files are created in the task specific execution directory which is considered as a temporary directory that can be deleted upon completion.</p>
</div>
<div class="paragraph">
<p>The pipeline result files need to be marked explicitly using the directive <a href="https://www.nextflow.io/docs/latest/process.html#publishdir">publishDir</a> in the process that’s creating such file. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process makeBams {
    publishDir "/some/directory/bam_files", mode: 'copy'

    input:
    file index from index_ch
    tuple val(name), file(reads) from reads_ch

    output:
    tuple val(name), file ('*.bam') into star_aligned

    """
    STAR --genomeDir $index --readFilesIn $reads
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will copy all bam files created by the star task in the directory path <code>/some/directory/bam_files</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The publish directory can be local or remote. For example output files could be stored to a <a href="https://aws.amazon.com/s3/">AWS S3 bucket</a> just using the <code>s3://</code> prefix in the target path.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use more then one publishDir to keep different outputs in separate directory. For example:</p>
</div>
</div>
<div class="sect3">
<h4 id="_manage_semantic_sub_directories">4.6.2. Manage semantic sub-directories</h4>
<div class="paragraph">
<p>You can use more then one <code>publishDir</code> to keep different outputs in separate directory. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.reads = 'data/reads/*_{1,2}.fq.gz'
params.outdir = 'my-results'

Channel
    .fromFilePairs(params.reads, flat: true)
    .set{ samples_ch }

process foo {
  publishDir "$params.outdir/$sampleId/", pattern: '*.fq'
  publishDir "$params.outdir/$sampleId/counts", pattern: "*_counts.txt"
  publishDir "$params.outdir/$sampleId/outlooks", pattern: '*_outlook.txt'

  input:
    set sampleId, file('sample1.fq.gz'), file('sample2.fq.gz') from samples_ch
  output:
    file "*"
  script:
  """
    &lt; sample1.fq.gz zcat &gt; sample1.fq
    &lt; sample2.fq.gz zcat &gt; sample2.fq

    awk '{s++}END{print s/4}' sample1.fq &gt; sample1_counts.txt
    awk '{s++}END{print s/4}' sample2.fq &gt; sample2_counts.txt

    head -n 50 sample1.fq &gt; sample1_outlook.txt
    head -n 50 sample2.fq &gt; sample2_outlook.txt
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will create an output structure in the directory my-results, which contains a separate sub-directory for each given sample ID each of which contain the folders counts and outlooks.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operators">5. Operators</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Built-in functions applied to channels</p>
</li>
<li>
<p>Transform channels content</p>
</li>
<li>
<p>Can be used also to filter, fork and combine channels</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_basic_example">5.1. Basic example</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">nums = Channel.from(1,2,3,4)         <i class="conum" data-value="1"></i><b>(1)</b>
square = nums.map { it -&gt; it * it }  <i class="conum" data-value="2"></i><b>(2)</b>
square.view()                        <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./assets/channel-map.png" alt="channel map">
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a queue channel emitting four values.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a new channels transforming each number in it&#8217;s square.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Print the channel content.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Operators can be chained to implement custom behaviors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel.from(1,2,3,4)
        .map { it -&gt; it * it }
        .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Operators can be separated in to five groups:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Filtering operators</p>
</li>
<li>
<p>Transforming operators</p>
</li>
<li>
<p>Splitting operators</p>
</li>
<li>
<p>Combining operators</p>
</li>
<li>
<p>Forking operators</p>
</li>
<li>
<p>Maths operators</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_basic_operators">5.2. Basic operators</h3>
<div class="sect3">
<h4 id="_view">5.2.1. view</h4>
<div class="paragraph">
<p>The <code>view</code> operator prints the items emitted by a channel to the console standard output appending a
<em>new line</em> character to each of them. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
      .from('foo', 'bar', 'baz')
      .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>foo
bar
baz</code></pre>
</div>
</div>
<div class="paragraph">
<p>An optional <em>closure</em> parameter can be specified to customise how items are printed. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
      .from('foo', 'bar', 'baz', 'qux')
      .view { "- $it" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>- foo
- bar
- baz</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_map">5.2.2. map</h4>
<div class="paragraph">
<p>The <code>map</code> operator applies a function of your choosing to every item emitted by a channel, and returns the items so obtained as a new channel. The function applied is called the <em>mapping</em> function and is expressed with a <em>closure</em> as shown in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .from( 'hello', 'world' )
    .map { it -&gt; it.reverse() }
    .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>map</code> can associate to each element a generic <em>tuple</em> containing any data as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .from( 'hello', 'world' )
    .map { word -&gt; [word, word.size()] }
    .view { word, len -&gt; "$word contains $len letters" }</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_11">Exercise</h5>
<div class="paragraph">
<p>Use <code>fromPath</code> to create a channel emitting the <em>fastq</em> files matching the pattern <code>data/ggal/*.fq</code>,
then chain with a map to return a pair containing the file name and the path itself.
Finally print the resulting channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel.fromPath('data/ggal/*.fq')
        .map { file -&gt; [ file.name, file ] }
        .view { name, file -&gt; "&gt; file: $name" }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_into">5.2.3. into</h4>
<div class="paragraph">
<p>The <code>into</code> operator connects a source channel to two or more target channels in such a way the values emitted by the source channel are copied to the target channels. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
     .from( 'a', 'b', 'c' )
     .into{ foo; bar }

foo.view{ "Foo emits: " + it }
bar.view{ "Bar emits: " + it }</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note the use in this example of curly brackets and the <code>;</code> as channel names separator. This is needed because the actual parameter of into is a <em>closure</em> which defines the target channels to which the source one is connected.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_mix">5.2.4. mix</h4>
<div class="paragraph">
<p>The <code>mix</code> operator combines the items emitted by two (or more) channels into a single channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">c1 = Channel.from( 1,2,3 )
c2 = Channel.from( 'a','b' )
c3 = Channel.from( 'z' )

c1 .mix(c2,c3).view()</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>1
2
a
3
b
z</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The items in the resulting channel have the same order as in respective original channel,
however there&#8217;s no guarantee that the element of the second channel are append after the elements
of the first. Indeed in the above example the element <code>a</code> has been printed before <code>3</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_flatten">5.2.5. flatten</h4>
<div class="paragraph">
<p>The <code>flatten</code> operator transforms a channel in such a way that every <em>tuple</em> is flattened so that each single entry is emitted as a sole element by the resulting channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">foo = [1,2,3]
bar = [4, 5, 6]

Channel
    .from(foo, bar)
    .flatten()
    .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above snippet prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>1
2
3
4
5
6</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_collect">5.2.6. collect</h4>
<div class="paragraph">
<p>The <code>collect</code> operator collects all the items emitted by a channel to a list and return the resulting object as a sole emission.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .from( 1, 2, 3, 4 )
    .collect()
    .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints a single value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[1,2,3,4]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The result of the <code>collect</code> operator is a <strong>value</strong> channel.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_grouptuple">5.2.7. groupTuple</h4>
<div class="paragraph">
<p>The <code>groupTuple</code> operator collects tuples (or lists) of values emitted by the source channel grouping together the elements that share the same key. Finally it emits a new tuple object for each distinct key collected.</p>
</div>
<div class="paragraph">
<p>Try the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
     .from( [1,'A'], [1,'B'], [2,'C'], [3, 'B'], [1,'C'], [2, 'A'], [3, 'D'] )
     .groupTuple()
     .view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>It shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[1, [A, B, C]]
[2, [C, A]]
[3, [B, D]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This operator is useful to process altogether all elements for which there&#8217;s a common
property or a grouping key.</p>
</div>
<div class="sect4">
<h5 id="_exercise_12">Exercise</h5>
<div class="paragraph">
<p>Use <code>fromPath</code> to create a channel emitting the <em>fastq</em> files matching the pattern <code>data/ggal/*.fq</code>,
then use a <code>map</code> to associate to each file the name prefix. Finally group together all
files having the same common prefix.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_join">5.2.8. join</h4>
<div class="paragraph">
<p>The <code>join</code> operator creates a channel that joins together the items emitted by two channels for which exits a matching key. The key is defined, by default, as the first element in each item emitted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">left = Channel.from(['X', 1], ['Y', 2], ['Z', 3], ['P', 7])
right= Channel.from(['Z', 6], ['Y', 5], ['X', 4])
left.join(right).view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting channel emits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[Z, 3, 6]
[Y, 2, 5]
[X, 1, 4]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_branch">5.2.9. branch</h4>
<div class="paragraph">
<p>The <code>branch</code> operator allows you to forward the items emitted by a source channel to one or more output channels, choosing one out of them at a time.</p>
</div>
<div class="paragraph">
<p>The selection criteria is defined by specifying a closure that provides one or more boolean expression, each of which is identified by a unique label. On the first expression that evaluates to a true value, the current item is bound to a named channel as the label identifier. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .from(1,2,3,40,50)
    .branch {
        small: it &lt; 10
        large: it &gt; 10
    }
    .set { result }

 result.small.view { "$it is small" }
 result.large.view { "$it is large" }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The branch operator returns a multi-channel object i.e. a variable that holds more than one channel object.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_more_resources">5.3. More resources</h3>
<div class="paragraph">
<p>Check the <a href="https://www.nextflow.io/docs/latest/operator.html">operators documentation</a> on Nextflow web site.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_groovy_basic_structures_and_idioms">6. Groovy basic structures and idioms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nextflow is a DSL implemented on top of the Groovy programming lang, which in turns is a super-set of the Java programming
language. This means that Nextflow can run any Groovy and Java code.</p>
</div>
<div class="sect2">
<h3 id="_printing_values">6.1. Printing values</h3>
<div class="paragraph">
<p>To print something is as easy as using one of the <code>print</code> or <code>println</code> methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>println("Hello, World!")</pre>
</div>
</div>
<div class="paragraph">
<p>The only difference between the two is that the println method implicitly appends a new line character to the printed string.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
parenthesis for function invocations are optional. Therefore also the following is a valid syntax.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>println "Hello, World!"</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comments">6.2. Comments</h3>
<div class="paragraph">
<p>Comments use the same syntax as in the C-family programming languages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// comment a single config file

/*
   a comment spanning
   multiple lines
 */</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_variables">6.3. Variables</h3>
<div class="paragraph">
<p>To define a variable, simply assign a value to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x = 1
println x

x = new java.util.Date()
println x

x = -3.1499392
println x

x = false
println x

x = "Hi"
println x</pre>
</div>
</div>
<div class="paragraph">
<p>Local variables are defined using the <code>def</code> keyword:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def x = 'foo'</pre>
</div>
</div>
<div class="paragraph">
<p>It should be always used when defining variables local to a function or a closure.</p>
</div>
</div>
<div class="sect2">
<h3 id="_lists">6.4. Lists</h3>
<div class="paragraph">
<p>A List object can be defined by placing the list items in square brackets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>list = [10,20,30,40]</pre>
</div>
</div>
<div class="paragraph">
<p>You can access a given item in the list with square-bracket notation (indexes start at <code>0</code>) or using the <code>get</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>assert list[0] == 10
assert list[0] == list.get(0)</pre>
</div>
</div>
<div class="paragraph">
<p>In order to get the length of the list use the size method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>assert list.size() == 4</pre>
</div>
</div>
<div class="paragraph">
<p>Lists can also be indexed with negative indexes and reversed ranges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>list = [0,1,2]
assert list[-1] == 2
assert list[-1..0] == list.reverse()</pre>
</div>
</div>
<div class="paragraph">
<p>List objects implements all methods provided by the Java <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html">java.util.List</a>
interface plus the extension methods provided by <a href="http://docs.groovy-lang.org/latest/html/groovy-jdk/java/util/List.html">Groovy API</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>assert [1,2,3] &lt;&lt; 1 == [1,2,3,1]
assert [1,2,3] + [1] == [1,2,3,1]
assert [1,2,3,1] - [1] == [2,3]
assert [1,2,3] * 2 == [1,2,3,1,2,3]
assert [1,[2,3]].flatten() == [1,2,3]
assert [1,2,3].reverse() == [3,2,1]
assert [1,2,3].collect{ it+3 } == [4,5,6]
assert [1,2,3,1].unique().size() == 3
assert [1,2,3,1].count(1) == 2
assert [1,2,3,4].min() == 1
assert [1,2,3,4].max() == 4
assert [1,2,3,4].sum() == 10
assert [4,2,1,3].sort() == [1,2,3,4]
assert [4,2,1,3].find{it%2 == 0} == 4
assert [4,2,1,3].findAll{it%2 == 0} == [4,2]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_maps">6.5. Maps</h3>
<div class="paragraph">
<p>Maps are like lists that have an arbitrary type of key instead of integer. Therefore, the syntax is very much aligned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>map = [a:0, b:1, c:2]</pre>
</div>
</div>
<div class="paragraph">
<p>Maps can be accessed in a conventional square-bracket syntax or as if the key was a property of the map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>assert map['a'] == 0     <i class="conum" data-value="1"></i><b>(1)</b>
assert map.b == 1        <i class="conum" data-value="2"></i><b>(2)</b>
assert map.get('c') == 2 <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use of the square brackets.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a dot notation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use of get method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To add data or to modify a map, the syntax is similar to adding values to list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>map['a'] = 'x'      <i class="conum" data-value="1"></i><b>(1)</b>
map.b = 'y'         <i class="conum" data-value="2"></i><b>(2)</b>
map.put('c', 'z')   <i class="conum" data-value="3"></i><b>(3)</b>
assert map == [a:'x', b:'y', c:'z']</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use of the square brackets.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a dot notation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use of get method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Maps objects implements all methods provided by the Java <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a>
interface plus the extension methods provided by <a href="http://docs.groovy-lang.org/latest/html/groovy-jdk/java/util/Map.html">Groovy API</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_string_interpolation">6.6. String interpolation</h3>
<div class="paragraph">
<p>String literals can be defined enclosing them either with single-quoted or double-quotes characters.</p>
</div>
<div class="paragraph">
<p>Double-quoted strings can contain the value of an arbitrary variable by prefixing its name with the <code>$</code> character, or the value of
any expression by using the ${expression} syntax, similar to Bash/shell scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>foxtype = 'quick'
foxcolor = ['b', 'r', 'o', 'w', 'n']
println "The $foxtype ${foxcolor.join()} fox"

x = 'Hello'
println '$x + $y'</pre>
</div>
</div>
<div class="paragraph">
<p>This code prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>The quick brown fox
$x + $y</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note the different use of <code>$</code> and <code>${..}</code> syntax to interpolate value expressions in a string literal.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally string literals can also be defined using the <code>/</code> character as delimiter. They are known as <strong>slashy</strong>
strings and are useful for defining regular expressions and patterns, as there is no need to escape backslashes.
As with double quote strings they allow to interpolate variables prefixed with a <code>$</code> character.</p>
</div>
<div class="paragraph">
<p>Try the following to see the difference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x = /tic\tac\toe/
y = 'tic\tac\toe'

println x
println y</pre>
</div>
</div>
<div class="paragraph">
<p>it prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>tic\tac\toe
tic    ac    oe</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multi_line_strings">6.7. Multi-line strings</h3>
<div class="paragraph">
<p>A block of text that span multiple lines can be defined by delimiting it with triple single or double quotes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>text = """
    Hello there James
    how are you today?
    """</pre>
</div>
</div>
<div class="paragraph">
<p>Finally multi-line strings can also be defined with slashy string. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>text = /
    This is a multi-line
    slashy string!
    It's cool, isn't it?!
    /</pre>
</div>
</div>
<div class="paragraph">
<p>Like before, multi-line strings inside double quotes and slash characters support variable interpolation,
while single-quoted multi-line strings do not.</p>
</div>
</div>
<div class="sect2">
<h3 id="_if_statement">6.8. If statement</h3>
<div class="paragraph">
<p>The <code>if</code> statement uses the same syntax common other programming lang such Java, C, JavaScript, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if( &lt; boolean expression &gt; ) {
    // true branch
}
else {
    // false branch
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>else</code> branch is optional. Also curly brackets are optional when the branch define just a single statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x = 1
if( x &gt; 10 )
    println 'Hello'</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>null</code>, empty strings and empty collections are evaluated to <code>false</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Therefore a statement like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>list = [1,2,3]
if( list != null &amp;&amp; list.size() &gt; 0 ) {
  println list
}
else {
  println 'The list is empty'
}</pre>
</div>
</div>
<div class="paragraph">
<p>Can be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if( list )
    println list
else
    println 'The list is empty'</pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="http://groovy-lang.org/semantics.html#Groovy-Truth">Groovy-Truth</a> for details.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In some cases can be useful to replace <code>if</code> statement with a ternary expression aka conditional expression. For example:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>println list ? list : 'The list is empty'</pre>
</div>
</div>
<div class="paragraph">
<p>The previous statement can be further simplified using the Elvis operator as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>println list ?: 'The list is empty'</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_for_statement">6.9. For statement</h3>
<div class="paragraph">
<p>The classical <code>for</code> loop syntax is supported as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>for (int i = 0; i &lt;3; i++) {
   println("Hello World $i")
}</pre>
</div>
</div>
<div class="paragraph">
<p>Iteration over list objects is also possible using the syntax below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>list = ['a','b','c']

for( String elem : list ) {
  println elem
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions">6.10. Functions</h3>
<div class="paragraph">
<p>It is possible to define a custom function into a script, as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int fib(int n) {
    return n &lt; 2 ? 1 : fib(n-1) + fib(n-2)
}

assert fib(10)==89</pre>
</div>
</div>
<div class="paragraph">
<p>A function can take multiple arguments separating them with a comma. The return keyword can be omitted
and the function implicitly returns the value of the last evaluated expression. Also explicit types can
be omitted (thought not recommended):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def fact( n ) {
  n &gt; 1 ? n * fact(n-1) : 1
}

assert fact(5) == 120</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_closures">6.11. Closures</h3>
<div class="paragraph">
<p>Closures are the swiss army knife of Nextflow/Groovy programming. In a nutshell a closure is is a block
of code that can be passed as an argument to a function, it could also be defined an anonymous function.</p>
</div>
<div class="paragraph">
<p>More formally, a closure allows the definition of functions as first class objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>square = { it * it }</pre>
</div>
</div>
<div class="paragraph">
<p>The curly brackets around the expression <code>it * it</code> tells the script interpreter to treat this expression as code.
The <code>it</code> identifier is an implicit variable that represents the value that is passed to the function when it is invoked.</p>
</div>
<div class="paragraph">
<p>Once compiled the function object is assigned to the variable <code>square</code> as any other variable assignments shown previously.
To invoke the closure execution use the special method <code>call</code> or just use the round parentheses to specify the closure parameter(s).
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>assert square.call(5) == 25
assert square(9) == 81</pre>
</div>
</div>
<div class="paragraph">
<p>This is not very interesting until we find that we can pass the function <code>square</code> as an argument to other functions or methods.
Some built-in functions take a function like this as an argument. One example is the <code>collect</code> method on lists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x = [ 1, 2, 3, 4 ].collect(square)
println x</pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ 1, 4, 9, 16 ]</pre>
</div>
</div>
<div class="paragraph">
<p>By default, closures take a single parameter called <code>it</code>, to give it a different name use the <code>&#8594;</code> syntax. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>square = { num -&gt; num * num }</pre>
</div>
</div>
<div class="paragraph">
<p>It’s also possible to define closures with multiple, custom-named parameters.</p>
</div>
<div class="paragraph">
<p>For example, the method <code>each()</code> when applied to a map can take a closure with two arguments, to which it passes the <em>key-value</em>
pair for each entry in the map object. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>printMap = { a, b -&gt; println "$a with value $b" }
values = [ "Yue" : "Wu", "Mark" : "Williams", "Sudha" : "Kumari" ]
values.each(printMap)</pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Yue with value Wu
Mark with value Williams
Sudha with value Kumari</pre>
</div>
</div>
<div class="paragraph">
<p>A closure has two other important features. First, it can access and <em>modify</em> variables in the scope where it is defined.</p>
</div>
<div class="paragraph">
<p>Second, a closure can be defined in an <em>anonymous</em> manner, meaning that it is not given a name, and is defined in the place
where it needs to be used.</p>
</div>
<div class="paragraph">
<p>As an example showing both these features, see the following code fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>result = 0  <i class="conum" data-value="1"></i><b>(1)</b>
values = ["China": 1 , "India" : 2, "USA" : 3] <i class="conum" data-value="2"></i><b>(2)</b>
values.keySet().each { result += values[it] }  <i class="conum" data-value="3"></i><b>(3)</b>
println result</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a global variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a map object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Invoke the each method passing closure object which modifies the result variable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Learn more about closures in the <a href="http://groovy-lang.org/closures.html">Groovy documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_more_resources_2">6.12. More resources</h3>
<div class="paragraph">
<p>The complete Groovy language documentation is available at this <a href="http://groovy-lang.org/documentation.html#languagespecification">link</a>.</p>
</div>
<div class="paragraph">
<p>A great resource to master Apache Groovy syntax is <a href="https://www.manning.com/books/groovy-in-action-second-edition">Groovy in Action</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simple_rna_seq_pipeline">7. Simple Rna-Seq pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During this tutorial you will implement a proof of concept of a RNA-Seq pipeline which:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Indexes a trascriptome file.</p>
</li>
<li>
<p>Performs quality controls</p>
</li>
<li>
<p>Performs quantification.</p>
</li>
<li>
<p>Create a MultiqQC report.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_define_the_pipeline_parameters">7.1. Define the pipeline parameters</h3>
<div class="paragraph">
<p>The script <code>script1.nf</code> defines the pipeline input parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">params.reads = "$baseDir/data/ggal/*_{1,2}.fq"
params.transcriptome = "$baseDir/data/ggal/transcriptome.fa"
params.multiqc = "$baseDir/multiqc"

println "reads: $params.reads"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it by using the
following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script1.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Try to specify a different input parameter, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script1.nf --reads this/and/that</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_13">7.1.1. Exercise</h4>
<div class="paragraph">
<p>Modify the <code>script1.nf</code> adding a fourth parameter named <code>outdir</code> and set it to a default path
that will be used as the pipeline output directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_14">7.1.2. Exercise</h4>
<div class="paragraph">
<p>Modify the <code>script1.nf</code> to print all the pipeline parameters by using a single <code>log.info</code> command and a <a href="https://www.nextflow.io/docs/latest/script.html#multi-line-strings">multiline string</a> statement.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
see an example <a href="https://github.com/nextflow-io/rnaseq-nf/blob/3b5b49f/main.nf#L41-L48">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recap">7.1.3. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to define parameters in your pipeline script</p>
</li>
<li>
<p>How to pass parameters by using the command line</p>
</li>
<li>
<p>The use of <code>$var</code> and <code>${var}</code> variable placeholders</p>
</li>
<li>
<p>How to use multiline strings</p>
</li>
<li>
<p>How to use <code>log.info</code> to print information and save it in the log execution file</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_transcriptome_index_file">7.2. Create transcriptome index file</h3>
<div class="paragraph">
<p>Nextflow allows the execution of any command or user script by using a <code>process</code> definition.</p>
</div>
<div class="paragraph">
<p>A process is defined by providing three main declarations:
the process <a href="https://www.nextflow.io/docs/latest/process.html#inputs">inputs</a>,
the process <a href="https://www.nextflow.io/docs/latest/process.html#outputs">outputs</a>
and finally the command <a href="https://www.nextflow.io/docs/latest/process.html#script">script</a>.</p>
</div>
<div class="paragraph">
<p>The second example adds the <code>index</code> process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">/*
 * pipeline input parameters
 */
params.reads = "$baseDir/data/ggal/*_{1,2}.fq"
params.transcriptome = "$baseDir/data/ggal/transcriptome.fa"
params.multiqc = "$baseDir/multiqc"
params.outdir = "results"

log.info """\
         R N A S E Q - N F   P I P E L I N E
         ===================================
         transcriptome: ${params.transcriptome}
         reads        : ${params.reads}
         outdir       : ${params.outdir}
         """
         .stripIndent()

/*
 * define the `index` process that create a binary index
 * given the transcriptome file
 */
process index {

    input:
    path transcriptome from params.transcriptome

    output:
    path 'index' into index_ch

    script:
    """
    salmon index --threads $task.cpus -t $transcriptome -i index
    """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It takes the transcriptome file as input and creates the transcriptome index by using the <code>salmon</code> tool.</p>
</div>
<div class="paragraph">
<p>Note how the input declaration defines a <code>transcriptome</code> variable in the process context
that it is used in the command script to reference that file in the Salmon command line.</p>
</div>
<div class="paragraph">
<p>Try to run it by using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script2.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The execution will fail because Salmon is not installed in your environment.</p>
</div>
<div class="paragraph">
<p>Add the command line option <code>-with-docker</code> to launch the execution through a Docker container
as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script2.nf -with-docker</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time it works because it uses the Docker container <code>nextflow/rnaseq-nf</code> defined in the
<code>nextflow.config</code> file.</p>
</div>
<div class="paragraph">
<p>In order to avoid to add the option <code>-with-docker</code> add the following line in the <code>nextflow.config</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">docker.enabled = true</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_15">7.2.1. Exercise</h4>
<div class="paragraph">
<p>Enable the Docker execution by default adding the above setting in the <code>nextflow.config</code> file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_16">7.2.2. Exercise</h4>
<div class="paragraph">
<p>Print the output of the <code>index_ch</code> channel by using the <a href="https://www.nextflow.io/docs/latest/operator.html#view">view</a>
operator.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_17">7.2.3. Exercise</h4>
<div class="paragraph">
<p>Use the command <code>tree work</code> to see how Nextflow organises the process work directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recap_2">7.2.4. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to define a process executing a custom command</p>
</li>
<li>
<p>How process inputs are declared</p>
</li>
<li>
<p>How process outputs are declared</p>
</li>
<li>
<p>How to access the number of available CPUs</p>
</li>
<li>
<p>How to print the content of a channel</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_collect_read_files_by_pairs">7.3. Collect read files by pairs</h3>
<div class="paragraph">
<p>This step shows how to match <strong>read</strong> files into pairs, so they can be mapped by <strong>Salmon</strong>.</p>
</div>
<div class="paragraph">
<p>Edit the script <code>script3.nf</code> and add the following statement as the last line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">read_pairs_ch.view()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save it and execute it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script3.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will print an output similar to the one shown below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ggal_gut, [/.../data/ggal/gut_1.fq, /.../data/ggal/gut_2.fq]]</pre>
</div>
</div>
<div class="paragraph">
<p>The above example shows how the <code>read_pairs_ch</code> channel emits tuples composed by
two elements, where the first is the read pair prefix and the second is a list
representing the actual files.</p>
</div>
<div class="paragraph">
<p>Try it again specifying different read files by using a glob pattern:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script3.nf --reads 'data/ggal/*_{1,2}.fq'</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
File paths including one or more wildcards ie. <code>*</code>, <code>?</code>, etc. MUST be
wrapped in single-quoted characters to avoid Bash expands the glob.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_exercise_18">7.3.1. Exercise</h4>
<div class="paragraph">
<p>Use the <a href="https://www.nextflow.io/docs/latest/operator.html#set">set</a> operator in place
of <code>=</code> assignment to define the <code>read_pairs_ch</code> channel.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_19">7.3.2. Exercise</h4>
<div class="paragraph">
<p>Use the <code>checkIfExists</code> option from the <a href="https://www.nextflow.io/docs/latest/channel.html#fromfilepairs">fromFilePairs</a> method
to check if the specified path contains at least a file pair.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recap_3">7.3.3. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to use <code>fromFilePairs</code> to handle read pair files</p>
</li>
<li>
<p>How to use the <code>set</code> operator to define a new channel variable</p>
</li>
<li>
<p>How to use the <code>checkIfExists</code> option to check input file existence</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_perform_expression_quantification">7.4. Perform expression quantification</h3>
<div class="paragraph">
<p>The script <code>script4.nf</code> adds the <code>quantification</code> process.</p>
</div>
<div class="paragraph">
<p>In this script note as the <code>index_ch</code> channel, declared as output in the <code>index</code> process,
is now used as a channel in the input section.</p>
</div>
<div class="paragraph">
<p>Also note as the second input is declared as a <code>tuple</code> composed by two elements:
the <code>pair_id</code> and the <code>reads</code> in order to match the structure of the items emitted
by the <code>read_pairs_ch</code> channel.</p>
</div>
<div class="paragraph">
<p>Execute it by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script4.nf -resume</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see the execution of the <code>quantification</code> process.</p>
</div>
<div class="paragraph">
<p>The <code>-resume</code> option cause the execution of any step that has been already processed to be skipped.</p>
</div>
<div class="paragraph">
<p>Try to execute it with more read files as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script4.nf -resume --reads 'data/ggal/*_{1,2}.fq'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice that the <code>quantification</code> process is executed more than
one time.</p>
</div>
<div class="paragraph">
<p>Nextflow parallelizes the execution of your pipeline simply by providing multiple input data
to your script.</p>
</div>
<div class="sect3">
<h4 id="_exercise_20">7.4.1. Exercise</h4>
<div class="paragraph">
<p>Add a <a href="https://www.nextflow.io/docs/latest/process.html#tag">tag</a> directive to the
<code>quantification</code> process to provide a more readable execution log.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_21">7.4.2. Exercise</h4>
<div class="paragraph">
<p>Add a <a href="https://www.nextflow.io/docs/latest/process.html#publishdir">publishDir</a> directive
to the <code>quantification</code> process to store the process results into a directory of your choice.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recap_4">7.4.3. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to connect two processes by using the channel declarations</p>
</li>
<li>
<p>How to resume the script execution skipping already computed steps</p>
</li>
<li>
<p>How to use the <code>tag</code> directive to provide a more readable execution output</p>
</li>
<li>
<p>How to use the <code>publishDir</code> to store a process results in a path of your choice</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quality_control">7.5. Quality control</h3>
<div class="paragraph">
<p>This step implements a quality control of your input reads. The inputs are the same
read pairs which are provided to the <code>quantification</code> steps</p>
</div>
<div class="paragraph">
<p>You can run it by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script5.nf -resume</code></pre>
</div>
</div>
<div class="paragraph">
<p>The script will report the following error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Channel `read_pairs_ch` has been used twice as an input by process `fastqc` and process `quantification`</pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_22">7.5.1. Exercise</h4>
<div class="paragraph">
<p>Modify the creation of the <code>read_pairs_ch</code> channel by using a <a href="https://www.nextflow.io/docs/latest/operator.html#into">into</a>
operator in place of a <code>set</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
see an example <a href="https://github.com/nextflow-io/rnaseq-nf/blob/3b5b49f/main.nf#L58">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recap_5">7.5.2. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to use the <code>into</code> operator to create multiple copies of the same channel</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multiqc_report">7.6. MultiQC report</h3>
<div class="paragraph">
<p>This step collect the outputs from the <code>quantification</code> and <code>fastqc</code> steps to create
a final report by using the <a href="http://multiqc.info/">MultiQC</a> tool.</p>
</div>
<div class="paragraph">
<p>Execute the script with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script6.nf -resume --reads 'data/ggal/*_{1,2}.fq'</code></pre>
</div>
</div>
<div class="paragraph">
<p>It creates the final report in the <code>results</code> folder in the current work directory.</p>
</div>
<div class="paragraph">
<p>In this script note the use of the <a href="https://www.nextflow.io/docs/latest/operator.html#mix">mix</a>
and <a href="https://www.nextflow.io/docs/latest/operator.html#collect">collect</a> operators chained
together to get all the outputs of the <code>quantification</code> and <code>fastqc</code> process as a single
input.</p>
</div>
<div class="sect3">
<h4 id="_recap_6">7.6.1. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to collect many outputs to a single input with the <code>collect</code> operator</p>
</li>
<li>
<p>How to <code>mix</code> two channels in a single channel</p>
</li>
<li>
<p>How to chain two or more operators together</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handle_completion_event">7.7. Handle completion event</h3>
<div class="paragraph">
<p>This step shows how to execute an action when the pipeline completes the execution.</p>
</div>
<div class="paragraph">
<p>Note that Nextflow processes define the execution of <strong>asynchronous</strong> tasks i.e. they are not
executed one after another as they are written in the pipeline script as it would happen in a
common <strong>imperative</strong> programming language.</p>
</div>
<div class="paragraph">
<p>The script uses the <code>workflow.onComplete</code> event handler to print a confirmation message
when the script completes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">workflow.onComplete {
    println ( workflow.success ? "\nDone! Open the following report in your browser --&gt;  $params.outdir/multiqc_report.html\n" : "Oops .. something went wrong" )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Try to run it by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script7.nf -resume --reads 'data/ggal/*_{1,2}.fq'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_custom_scripts">7.8. Custom scripts</h3>
<div class="paragraph">
<p>Real world pipelines use a lot of custom user scripts (BASH, R, Python, etc). Nextflow
allows you to use and manage all these scripts in consistent manner. Simply put them
in a directory named <code>bin</code> in the pipeline project root. They will be automatically added
to the pipeline execution <code>PATH</code>.</p>
</div>
<div class="paragraph">
<p>For example, create a file named <code>fastqc.sh</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash
set -e
set -u

sample_id=${1}
reads=${2}

mkdir fastqc_${sample_id}_logs
fastqc -o fastqc_${sample_id}_logs -f fastq -q ${reads}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save it, give execute permission and move it in the <code>bin</code> directory as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">chmod +x fastqc.sh
mkdir -p bin
mv fastqc.sh bin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, open the <code>script7.nf</code> file and replace the <code>fastqc</code> process' script with
the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">script:
"""
fastqc.sh "$sample_id" "$reads"
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it as before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script7.nf -resume --reads 'data/ggal/*_{1,2}.fq'</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_recap_7">7.8.1. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to write or use existing custom script in your Nextflow pipeline.</p>
</li>
<li>
<p>How to avoid the use of absolute paths having your scripts in the <code>bin/</code> project folder.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metrics_and_reports">7.9. Metrics and reports</h3>
<div class="paragraph">
<p>Nextflow is able to produce multiple reports and charts providing several runtime metrics and execution information.</p>
</div>
<div class="paragraph">
<p>Run the <a href="https://github.com/nextflow-io/rnaseq-nf">rnaseq-nf</a> pipeline previously introduced as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run rnaseq-nf -with-docker -with-report -with-trace -with-timeline -with-dag dag.png</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-with-report</code> option enables the creation of the workflow execution report. Open the file <code>report.html</code> with a browser to see the report created with the above command.</p>
</div>
<div class="paragraph">
<p>The <code>-with-trace</code> option enables the create of a tab separated file containing runtime information for each executed task. Check the content of the file <code>trace.txt</code> for an example.</p>
</div>
<div class="paragraph">
<p>The <code>-with-timeline</code> option enables the creation of the workflow timeline report showing how processes where executed along time. This may
be useful to identify most time consuming tasks and bottlenecks. See an example at <a href="https://www.nextflow.io/docs/latest/tracing.html#timeline-report">this link</a>.</p>
</div>
<div class="paragraph">
<p>Finally the <code>-with-dag</code> option enables to rendering of the workflow execution direct acyclic graph representation.
Note: this feature requires the installation of <a href="http://www.graphviz.org/">Graphviz</a> in your computer.
See <a href="https://www.nextflow.io/docs/latest/tracing.html#dag-visualisation">here</a> for details.</p>
</div>
<div class="paragraph">
<p>Note: runtime metrics may be incomplete for run short running tasks as in the case of this tutorial.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You view the HTML files right-clicking on the file name in the left side-bar and choosing the Preview menu item.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_mail_notification">7.10. Mail notification</h3>
<div class="paragraph">
<p>Send a notification email when the workflow execution complete using the <code>-N &lt;email address&gt;</code>
command line option. Execute again the previous example specifying your email address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run script7.nf -resume --reads 'data/ggal/*_{1,2}.fq' -N &lt;your email&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Your computer must have installed a pre-configured mail tool, such as <code>mail</code> or <code>sendmail</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively you can provide the settings of the STMP server needed to send the mail notification
in the Nextflow config file. See <a href="https://www.nextflow.io/docs/latest/mail.html#mail-configuration">mail documentation</a> for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_a_project_from_github">7.11. Run a project from GitHub</h3>
<div class="paragraph">
<p>Nextflow allows the execution of a pipeline project directly from a GitHub repository (or similar services eg. BitBucket and GitLab).</p>
</div>
<div class="paragraph">
<p>This simplifies the sharing and the deployment of complex projects and tracking changes in a consistent manner.</p>
</div>
<div class="paragraph">
<p>The following GitHub repository hosts a complete version of the workflow introduced in this tutorial:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/nextflow-io/rnaseq-nf">github.com/nextflow-io/rnaseq-nf</a></p>
</div>
<div class="paragraph">
<p>You can run it by specifying the project name as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run nextflow-io/rnaseq-nf -with-docker</code></pre>
</div>
</div>
<div class="paragraph">
<p>It automatically downloads it and store in the <code>$HOME/.nextflow</code> folder.
Use the command info to show the project information, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow info nextflow-io/rnaseq-nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nextflow allows the execution of a specific revision of your project by using the -r command line option. For Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run nextflow-io/rnaseq-nf -r dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Revision are defined by using Git tags or branches defined in the project repository.</p>
</div>
<div class="paragraph">
<p>This allows a precise control of the changes in your project files and dependencies over time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_more_resources_3">7.12. More resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.nextflow.io">Nextflow documentation</a> - The Nextflow docs home.</p>
</li>
<li>
<p><a href="https://github.com/nextflow-io/patterns">Nextflow patterns</a> - A collection of Nextflow implementation patterns.</p>
</li>
<li>
<p><a href="https://github.com/CRG-CNAG/CalliNGS-NF">CalliNGS-NF</a> - An Variant calling pipeline implementing GATK best practices.</p>
</li>
<li>
<p><a href="http://nf-co.re/">nf-core</a> - A community collection of production ready genomic pipelines.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_manage_dependencies_containers">8. Manage dependencies &amp; containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Computational workflows rarely are composed by as single script or tool.  Most of the times they require the usage of dozens of different software components or libraries.</p>
</div>
<div class="paragraph">
<p>Installing and maintaining such dependencies is a challenging task and the most common source of irreproducibility in scientific applications.</p>
</div>
<div class="paragraph">
<p>Containers are exceptionally useful in scientific workflows. They allow the encapsulation of software dependencies, i.e. tools and libraries required by a data analysis application in one or more self-contained, ready-to-run, immutable container images that can be easily deployed in any platform supporting the container runtime.</p>
</div>
<div class="sect2">
<h3 id="_docker_hands_on">8.1. Docker hands-on</h3>
<div class="paragraph">
<p>Get practice with basic Docker commands to pull, run and build your own containers.</p>
</div>
<div class="paragraph">
<p>A container is a ready-to-run Linux environment which can be executed in an isolated manner from the hosting system. It has own copy of the file system, processes space, memory management, etc.</p>
</div>
<div class="paragraph">
<p>Containers are a Linux feature known as Control Groups or <a href="https://en.wikipedia.org/wiki/Cgroups">Cgroups</a> introduced with kernel 2.6.</p>
</div>
<div class="paragraph">
<p>Docker adds to this concept an handy management tool to build, run and share container images.</p>
</div>
<div class="paragraph">
<p>These images can be uploaded and published in a centralised repository know as <a href="https://hub.docker.com/">Docker Hub</a>,
or hosted by other parties like for example <a href="https://quay.io/">Quay</a>.</p>
</div>
<div class="sect3">
<h4 id="_run_a_container">8.1.1. Run a container</h4>
<div class="paragraph">
<p>Run a container is easy as using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run &lt;container-name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run hello-world</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pull_a_container">8.1.2. Pull a container</h4>
<div class="paragraph">
<p>The pull command allows you to download a Docker image without running it. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker pull debian:stretch-slim</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command download a Debian Linux image.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_container_in_interactive_mode">8.1.3. Run a container in interactive mode</h4>
<div class="paragraph">
<p>Launching a BASH shell in the container allows you to operate in an interactive mode
in the containerised operating system. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run -it debian:jessie-slim bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once launched the container you wil noticed that&#8217;s running as root (!).
Use the usual commands to navigate in the file system.</p>
</div>
<div class="paragraph">
<p>To exit from the container, stop the BASH session with the exit command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_your_first_dockerfile">8.1.4. Your first Dockerfile</h4>
<div class="paragraph">
<p>Docker images are created by using a so called <code>Dockerfile</code> i.e. a simple text file
containing a list of commands to be executed to assemble and configure the image
with the software packages required.</p>
</div>
<div class="paragraph">
<p>In this step you will create a Docker image containing the Salmon tool.</p>
</div>
<div class="paragraph">
<p>Warning: the Docker build process automatically copies all files that are located in the
current directory to the Docker daemon in order to create the image. This can take
a lot of time when big/many files exist. For this reason it&#8217;s important to <strong>always</strong> work in
a directory containing only the files you really need to include in your Docker image.
Alternatively you can use the <code>.dockerignore</code> file to select the path to exclude from the build.</p>
</div>
<div class="paragraph">
<p>Then use your favourite editor eg. <code>vim</code> to create a file named <code>Dockerfile</code> and copy the
following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">FROM debian:jessie-slim

MAINTAINER &lt;your name&gt;

RUN apt-get update &amp;&amp; apt-get install -y curl cowsay

ENV PATH=$PATH:/usr/games/</code></pre>
</div>
</div>
<div class="paragraph">
<p>When done save the file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_build_the_image">8.1.5. Build the image</h4>
<div class="paragraph">
<p>Build the Docker image by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker build -t my-image .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: don&#8217;t miss the dot in the above command. When it completes, verify that the image
has been created listing all available images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker images</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can try your new container by running this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run my-image cowsay Hello Docker!</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_a_software_package_to_the_image">8.1.6. Add a software package to the image</h4>
<div class="paragraph">
<p>Add the Salmon package to the Docker image by adding to the <code>Dockerfile</code> the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">RUN curl -sSL https://github.com/COMBINE-lab/salmon/releases/download/v0.8.2/Salmon-0.8.2_linux_x86_64.tar.gz | tar xz \
 &amp;&amp; mv /Salmon-*/bin/* /usr/bin/ \
 &amp;&amp; mv /Salmon-*/lib/* /usr/lib/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and build again the image with the same command as before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker build -t my-image .</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice that it creates a new Docker image with the same name <strong>but</strong> with a
different image ID.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_salmon_in_the_container">8.1.7. Run Salmon in the container</h4>
<div class="paragraph">
<p>Check that everything is fine running Salmon in the container as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>docker run my-image salmon --version</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can even launch a container in an interactive mode by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>docker run -it my-image bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>exit</code> command to terminate the interactive session.</p>
</div>
</div>
<div class="sect3">
<h4 id="_file_system_mounts">8.1.8. File system mounts</h4>
<div class="paragraph">
<p>Create an genome index file by running Salmon in the container.</p>
</div>
<div class="paragraph">
<p>Try to run Salmon in the container with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run my-image \
  salmon index -t $PWD/data/ggal/transcriptome.fa -i index</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command fails because Salmon cannot access the input file.</p>
</div>
<div class="paragraph">
<p>This happens because the container runs in a complete separate file system and
it cannot access the hosting file system by default.</p>
</div>
<div class="paragraph">
<p>You will need to use the <code>--volume</code> command line option to mount the input file(s) eg.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run --volume $PWD/data/ggal/transcriptome.fa:/transcriptome.fa my-image \
  salmon index -t /transcriptome.fa -i index</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
the generated <code>transcript-index</code> directory is still not accessible in the host file system (and actually it went lost).
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
An easier way is to mount a parent directory to an identical one in the container,
this allows you to use the same path when running it in the container eg.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run --volume $HOME:$HOME --workdir $PWD my-image \
  salmon index -t $PWD/data/ggal/transcriptome.fa -i index</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the content of the transcript-index folder entering the command:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Note that the permissions for files created by the Docker execution is root.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise_23">Exercise</h5>
<div class="paragraph">
<p>Use the option <code>-u $(id -u):$(id -g)</code> to allow Docker to create files with the right permission.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_upload_the_container_in_the_docker_hub_bonus">8.1.9. Upload the container in the Docker Hub (bonus)</h4>
<div class="paragraph">
<p>Publish your container in the Docker Hub to share it with other people.</p>
</div>
<div class="paragraph">
<p>Create an account in the <a href="https://hub.docker.com">hub.docker.com</a> web site. Then from your shell terminal run
the following command, entering the user name and password you specified registering in the Hub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker login</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tag the image with your Docker user name account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker tag my-image &lt;user-name&gt;/my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally push it to the Docker Hub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker push &lt;user-name&gt;/my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that anyone will be able to download it by using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker pull &lt;user-name&gt;/my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how after a pull and push operation, Docker prints the container digest number e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Digest: sha256:aeacbd7ea1154f263cda972a96920fb228b2033544c2641476350b9317dab266
Status: Downloaded newer image for nextflow/rnaseq-nf:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a unique and immutable identifier that can be used to reference container image
in a univocally manner. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker pull nextflow/rnaseq-nf@sha256:aeacbd7ea1154f263cda972a96920fb228b2033544c2641476350b9317dab266</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_nextflow_script_using_a_docker_container">8.1.10. Run a Nextflow script using a Docker container</h4>
<div class="paragraph">
<p>The simplest way to run a Nextflow script with a Docker image is using the <code>-with-docker</code> command line option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">nextflow run script2.nf -with-docker my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>We’ll see later how to configure in the Nextflow config file which container to use instead of having to specify
every time as a command line argument.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_singularity">8.2. Singularity</h3>
<div class="paragraph">
<p><a href="https://singularity.lbl.gov/">Singularity</a> is container runtime designed to work in HPC data center, where the usage of Docker is generally not allowed due to security constraints.</p>
</div>
<div class="paragraph">
<p>Singularity implements a container execution model similarly to Docker however it uses a complete different implementation design.</p>
</div>
<div class="paragraph">
<p>A Singularity container image is archived as a plain file that can be stored in a shared file system and accessed by many computing nodes managed by a batch scheduler.</p>
</div>
<div class="sect3">
<h4 id="_create_a_singularity_image">8.2.1. Create a Singularity image</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="singularity">Singularity images are created using a Singularity file in similar manner to Docker, though using a different syntax.

Bootstrap: docker
From: debian:stretch-slim

%environment
export PATH=$PATH:/usr/games/

%labels
AUTHOR &lt;your name&gt;

%post

apt-get update &amp;&amp; apt-get install -y locales-all curl cowsay
curl -sSL https://github.com/COMBINE-lab/salmon/releases/download/v1.0.0/salmon-1.0.0_linux_x86_64.tar.gz | tar xz \
 &amp;&amp; mv /salmon-*/bin/* /usr/bin/ \
 &amp;&amp; mv /salmon-*/lib/* /usr/lib/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have save the <code>Singularity</code> file. Create the image with these commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo singularity build my-image.sif Singularity</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: the <code>build</code> command requires sudo permissions. A common workaround consists to build the image on a local
workstation and then deploy in the cluster just copying the image file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_a_container">8.2.2. Running a container</h4>
<div class="paragraph">
<p>Once done, you can run your container with the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">singularity exec my-image.sif cowsay 'Hello Singularity'</code></pre>
</div>
</div>
<div class="paragraph">
<p>By using the shell command you can enter in the container in interactive mode. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">singularity shell my-image.sif</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once in the container instance run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">touch hello.txt
ls -la</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note how the files on the host environment are shown. Singularity automatically mounts the host <code>$HOME</code> directory and uses the current work directory.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_import_a_docker_image">8.2.3. Import a Docker image</h4>
<div class="paragraph">
<p>An easier way to create Singularity container without requiring sudo permission and boosting the containers interoperability is to import a Docker container image pulling it directly from a Docker registry. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">singularity pull docker://debian:stretch-slim</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command automatically download the Debian Docker image and converts it to a Singularity image store in the current directory with the name <code>debian-jessie.simg</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_nextflow_script_using_a_singularity_container">8.2.4. Run a Nextflow script using a Singularity container</h4>
<div class="paragraph">
<p>Nextflow allows the transparent usage of Singularity containers as easy as with Docker ones.</p>
</div>
<div class="paragraph">
<p>It only requires to enable the use of Singularity engine in place of Docker in the Nextflow configuration file using the <code>-with-singularity</code> command line option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">nextflow run script7.nf -with-singularity nextflow/rnaseq-nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before the Singularity container can also be provided in the Nextflow config file. We’ll see later how to do it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_singularity_container_library">8.2.5. The Singularity Container Library</h4>
<div class="paragraph">
<p>The authors of Singularity, <a href="https://sylabs.io/">SyLabs</a> have their own repository of Singularity containers.</p>
</div>
<div class="paragraph">
<p>In the same way that we can push docker images to Docker Hub, we can upload Singularity images to the Singularity Library.</p>
</div>
</div>
<div class="sect3">
<h4 id="_condabioconda_packages">8.2.6. Conda/Bioconda packages</h4>
<div class="paragraph">
<p>Conda is popular package and environment manager. The built-in support for Conda allows Nextflow pipelines to automatically creates and activates the Conda environment(s) given the dependencies specified by each process.</p>
</div>
<div class="paragraph">
<p>A Conda environment is defined using a YAML file which lists the required software packages. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">name: nf-tutorial
channels:
  - defaults
  - bioconda
  - conda-forge
dependencies:
  - salmon=1.0.0
  - fastqc=0.11.5
  - multiqc=1.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the recipe file, the environment is created using the command shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conda env create --file env.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the environment was created successfully with the command shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conda env list</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable the environment you can use the <code>activate</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conda activate nf-tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nextflow is able to manage the activation of a Conda environment when the its directory is specified using the <code>-with-conda</code> option. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">nextflow run script7.nf -with-conda /home/ubuntu/miniconda2/envs/nf-tutorial</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When specifying as Conda environment a YAML recipe file, Nextflow automatically downloads the required dependencies, build the environment and automatically activate it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This makes easier to manage different environments for the processes in the workflow script.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://www.nextflow.io/docs/latest/conda.html">Nextflow</a> in the Nextflow documentation for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bonus_exercise">8.2.7. Bonus Exercise</h4>
<div class="paragraph">
<p>Take a look at the Dockerfile of the <a href="https://github.com/nextflow-io/rnaseq-nf">rnaseq-nf</a> pipeline to determine how it is built.</p>
</div>
</div>
<div class="sect3">
<h4 id="_biocontainers">8.2.8. BioContainers</h4>
<div class="paragraph">
<p>Another useful resource linking together Bioconda and containers is the <a href="https://biocontainers.pro/#/">BioContainers</a> project. BioContainers is a community
initiative that provides a registry of container images for every Bioconda recipe.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_file">9. Configuration file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a pipeline script is launched Nextflow looks for a file named <code>nextflow.config</code> in the current directory
and in the script base directory (if it is not the same as the current directory).
Finally it checks for the file <code>$HOME/.nextflow/config</code>.</p>
</div>
<div class="paragraph">
<p>When more than one on the above files exist they are merged, so that the settings
in the first override the same ones that may appear in the second one, and so on.</p>
</div>
<div class="paragraph">
<p>The default config file search mechanism can be extended proving an extra configuration
file by using the command line option <code>-c &lt;config file&gt;</code>.</p>
</div>
<div class="sect2">
<h3 id="_config_syntax">9.1. Config syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>name = value</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please note, string values need to be wrapped in quotation characters while numbers and boolean values
(<code>true</code>, <code>false</code>) do not. Also note that values are typed, meaning for example that, <code>1</code> is different from <code>'1'</code>,
since the first is interpreted as the number one, while the latter is interpreted as a string value.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_config_variables">9.2. Config variables</h3>
<div class="paragraph">
<p>Configuration properties can be used as variables in the configuration file itself, by using the usual
<code>$propertyName</code> or <code>${expression}</code> syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">propertyOne = 'world'
anotherProp = "Hello $propertyOne"
customPath = "$PATH:/my/app/folder"</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the configuration file it’s possible to access any variable defined in the host environment such
as <code>$PATH</code>, <code>$HOME</code>, <code>$PWD</code>, etc.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_config_comments">9.3. Config comments</h3>
<div class="paragraph">
<p>Configuration files use the same conventions for comments used in the Nextflow script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">// comment a single config file

/*
   a comment spanning
   multiple lines
 */</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_config_scopes">9.4. Config scopes</h3>
<div class="paragraph">
<p>Configuration settings can be organized in different scopes by dot prefixing the property names with
a scope identifier or grouping the properties in the same scope using the curly brackets notation.
This is shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">alpha.x  = 1
alpha.y  = 'string value..'

beta {
    p = 2
    q = 'another string ..'
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_config_params">9.5. Config params</h3>
<div class="paragraph">
<p>The scope <code>params</code> allows the definition of workflow parameters that overrides the values defined in the main workflow script.</p>
</div>
<div class="paragraph">
<p>This is useful to consolidate one or more execution parameters in a separate file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">// config file
params.foo = 'Bonjour'
params.bar = 'le monde!'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">// workflow script
params.foo = 'Hello'
params.bar = 'world!'

// print the both params
println "$params.foo $params.bar"</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_24">Exercise</h5>
<div class="paragraph">
<p>Save the first snippet as nextflow.config and the second one as params.nf. Then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run params.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute is again specifying the foo parameter on the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run params.nf --foo Hola</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compare the result of the two executions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_config_env">9.6. Config env</h3>
<div class="paragraph">
<p>The <code>env</code> scope allows the definition one or more variable that will be exported in the environment
where the workflow tasks will be executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">env.ALPHA = 'some value'
env.BETA = "$HOME/some/path"</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_25">Exercise</h5>
<div class="paragraph">
<p>Save the above snippet a file named <code>my-env.config</code>. The save the snippet below in a file named <code>foo.nf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  echo true
  '''
  env | egrep 'ALPHA|BETA'
  '''
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally executed the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run foo.nf -c my-env.config</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_config_process">9.7. Config process</h3>
<div class="paragraph">
<p>The process <a href="https://www.nextflow.io/docs/latest/process.html#directives">directives</a> allow the specification of specific settings for
the task execution such as <code>cpus</code>, <code>memory</code>, <code>container</code> and other resources in the pipeline script.</p>
</div>
<div class="paragraph">
<p>This is useful specially when prototyping a small workflow script.</p>
</div>
<div class="paragraph">
<p>However it’s always a good practice to decouple the workflow execution logic from the process configuration settings, i.e.
it’s strongly suggested to define the process settings in the workflow configuration file instead of the workflow script.</p>
</div>
<div class="paragraph">
<p>The <code>process</code> configuration scope allows the setting of any process <a href="https://www.nextflow.io/docs/latest/process.html#directives">directives</a>
in the Nextflow configuration file. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    cpus = 10
    memory = 8.GB
    container = 'biocontainers/bamtools:v2.4.0_cv3'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above config snippet defines the <code>cpus</code>, <code>memory</code> and <code>container</code> directives for all processes in your workflow script.</p>
</div>
<div class="paragraph">
<p>The <a href="https://www.nextflow.io/docs/latest/config.html#process-selectors">process selector</a> can be used to apply the configuration to a
specific process or group of processes (discussed later).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Memory and time duration unit can be specified either using a string based notation in which the digit(s) and the unit <strong>can</strong>
be separated by a blank or by using the numeric notation in which the digit(s) and the unit are separated by a dot character and
it’s not enclosed by quote characters.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">String syntax</th>
<th class="tableblock halign-center valign-top">Numeric syntax</th>
<th class="tableblock halign-center valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">'10 KB'</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">10.KB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">10240 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">'500 MB'</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">500.MB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">524288000 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">'1 min'</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1.min</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">60 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">'1 hour 25 sec'</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 hour and 25 seconds</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>INFO: The syntax for setting process directives in the configuration file requires <code>=</code> ie. assignment operator,
instead it should not be used when setting process directives in the workflow script.</p>
</div>
<div class="paragraph">
<p>This important especially when you want to define a config setting using a dynamic expression using a closure. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    memory = { 4.GB * task.cpus }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Directives that requires more than one value, e.g. <a href="https://www.nextflow.io/docs/latest/process.html#pod">pod</a>, in
the configuration file need to be expressed as a map object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    pod = [env: 'FOO', value: '123']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally directives that allows to be repeated in the process definition, in the configuration files need to
be defined as a list object. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    pod = [ [env: 'FOO', value: '123'],
            [env: 'BAR', value: '456'] ]
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_config_docker_execution">9.7.1. Config Docker execution</h4>
<div class="paragraph">
<p>The container image to be used for the process execution can be specified in the <code>nextflow.config</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process.container = 'nextflow/rnaseq-nf'
docker.enabled = true</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The use of the unique SHA256 image ID guarantees that the image content do not change over time
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process.container = 'nextflow/rnaseq-nf@sha256:aeacbd7ea1154f263cda972a96920fb228b2033544c2641476350b9317dab266'
docker.enabled = true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_singularity_execution">9.7.2. Config Singularity execution</h4>
<div class="paragraph">
<p>The run the workflow execution with a Singularity container provide the container image file path in the
Nextflow config file using the container directive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process.container = '/some/singularity/image.sif'
singularity.enabled = true</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The container image file must be an absolute path i.e. it must start with a <code>/</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following protocols are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>library://</code> download the container image from the <a href="https://cloud.sylabs.io/library">Singularity Library service</a>.</p>
</li>
<li>
<p><code>shub://</code> download the container image from the <a href="https://singularity-hub.org/">Singularity Hub</a>.</p>
</li>
<li>
<p><code>docker://</code> download the container image from the <a href="https://hub.docker.com/">Docker Hub</a> and convert it to the Singularity format.</p>
</li>
<li>
<p><code>docker-daemon://</code> pull the container image from a local Docker installation and convert it to a Singularity image file.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Specifying a plain Docker container image name, Nextflow implicitly download and converts it to a Singularity image
when the Singularity execution is enabled. For example:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process.container = 'nextflow/rnaseq-nf'
singularity.enabled = true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration instructs Nextflow to use Singularity engine to run your script processes. The container is pulled from
the Docker registry and cached in the current directory to be used for further runs.</p>
</div>
<div class="paragraph">
<p>Alternatively if you have a Singularity image file, its location absolute path can be specified as the container name either
using the <code>-with-singularity</code> option or the <code>process.container</code> setting in the config file.</p>
</div>
<div class="paragraph">
<p>Try to run the script as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run script7.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: Nextflow will pull the container image automatically, it will require a few seconds depending the network connection speed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_config_conda_execution">9.8. Config Conda execution</h3>
<div class="paragraph">
<p>The use of a Conda environment can also be provided in the configuration file adding the following setting in the <code>nextflow.config</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process.conda = "/home/ubuntu/miniconda2/envs/nf-tutorial"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can either specify the path of an existing Conda environment <strong>directory</strong> or the path of Conda environment YAML file.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployment_scenarios">10. Deployment scenarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Real world genomic application can spawn the execution of thousands of jobs. In this scenario a batch scheduler is
commonly used to deploy a pipeline in a computing cluster, allowing the execution of many jobs in parallel across many computing nodes.</p>
</div>
<div class="paragraph">
<p>Nextflow has built-in support for most common used batch schedulers such as
<a href="https://en.wikipedia.org/wiki/Univa_Grid_Engine">Univa Grid Engine</a> and <a href="https://en.wikipedia.org/wiki/Slurm_Workload_Manager">SLURM</a>
and <a href="https://en.wikipedia.org/wiki/Platform_LSF">IBM LSF</a> among others. Check the Nextflow documentation for the complete list of
supported <a href="https://www.nextflow.io/docs/latest/executor.html">execution platforms</a>.</p>
</div>
<div class="sect2">
<h3 id="_cluster_deployment">10.1. Cluster deployment</h3>
<div class="paragraph">
<p>A key Nextflow feature is the ability to decouple the workflow implementation from the actual execution platform implementing an abstraction layer that allows the deployment of the resulting workflow on any executing platform support by the framework.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./assets/nf-executors.png" alt="nf executors">
</div>
</div>
<div class="paragraph">
<p>To run your pipeline with a batch scheduler modify the <code>nextflow.config</code> file specifying the target executor and the required computing resources if needed. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process.executor = 'slurm'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_managing_cluster_resources">10.2. Managing cluster resources</h3>
<div class="paragraph">
<p>When using a batch scheduler is generally needed to specify the amount of resources i.e. cpus, memory, execution time, etc. required by each task.</p>
</div>
<div class="paragraph">
<p>This can be done using the following process directives:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 85.7143%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#queue">queue</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the cluster <em>queue</em> to be used for the computation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#cpus">cpus</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the number of <em>cpus</em> to be allocated a task execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#queue">memory</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the amount of <em>memory</em> to be allocated a task execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#time">time</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the max amount of <em>time</em> to be allocated a task execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#disk">disk</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the amount of disk storage required a task execution</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_workflow_wide_resources">10.2.1. Workflow wide resources</h4>
<div class="paragraph">
<p>Use the scope <code>process</code> to define the resource requirements for all processes in your workflow applications. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    executor = 'slurm'
    queue = 'short'
    memory = '10 GB'
    time = '30 min'
    cpus = 4
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_process_by_name">10.2.2. Configure process by name</h4>
<div class="paragraph">
<p>In real world application different tasks need different amount of computing resources. It is possible to define the resources for a specific task using the select <code>withName</code>: followed by the process name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    executor = 'slurm'
    queue = 'short'
    memory = '10 GB'
    time = '30 min'
    cpus = 4

    withName: foo {
        cpus = 4
        memory = '20 GB'
        queue = 'short'
    }

    withName: bar {
        cpus = 8
        memory = '32 GB'
        queue = 'long'
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_process_by_labels">10.2.3. Configure process by labels</h4>
<div class="paragraph">
<p>When a workflow application is composed by many processes can be overkill listing all process names in the configuration file to specifies the resources for each of them.</p>
</div>
<div class="paragraph">
<p>A better strategy consist to annotate the processes with a <a href="https://www.nextflow.io/docs/latest/process.html#label">label</a> directive. Then specify the resources in the configuration file using for all processes having the same label.</p>
</div>
<div class="paragraph">
<p>The workflow script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process task1 {
  label 'long'

  """
  first_command --here
  """
}

process task2 {
  label 'short'

  """
  second_command --here
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    executor = 'slurm'

    withLabel: 'short' {
        cpus = 4
        memory = '20 GB'
        queue = 'alpha'
    }

    withLabel: 'long' {
        cpus = 8
        memory = '32 GB'
        queue = 'omega'
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_multiple_containers">10.2.4. Configure multiple containers</h4>
<div class="paragraph">
<p>It is possible to use a different container for each process in your workflow. For having a workflow script defining two process, it’s possible to define a config file as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
  withName: foo {
    container = 'some/image:x'
  }
  withName: bar {
    container = 'other/image:y'
  }
}

docker.enabled = true</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A single <em>fat</em> container or many <em>slim</em> containers? Both approaches have pros &amp; cons. A single container is simpler to build and to maintain,
however when using many tools the image can become very big and tools can conflict each other. Using a container for each process can result in many different images to build and to maintain, especially when processes in your workflow uses different tools in each task.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Read more about config process selector at <a href="https://www.nextflow.io/docs/latest/config.html#process-selectors">this link</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_profiles">10.3. Configuration profiles</h3>
<div class="paragraph">
<p>Configuration files can contain the definition of one or more <em>profiles</em>. A profile is a set of configuration attributes that can be activated/chosen when launching a pipeline execution by using the <code>-profile</code> command line option.</p>
</div>
<div class="paragraph">
<p>Configuration profiles are defined by using the special scope <code>profiles</code> which group the attributes that belong to the same profile using a common prefix. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">profiles {

    standard {
        params.genome = '/local/path/ref.fasta'
        process.executor = 'local'
    }

    cluster {
        params.genome = '/data/stared/ref.fasta'
        process.executor = 'sge'
        process.queue = 'long'
        process.memory = '10GB'
        process.conda = '/some/path/env.yml'
    }

    cloud {
        params.genome = '/data/stared/ref.fasta'
        process.executor = 'awsbatch'
        process.container = 'cbcrg/imagex'
        docker.enabled = true
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration defines three different profiles: standard, cluster and cloud that set different process configuration strategies depending on the target runtime platform. By convention the standard profile is implicitly used when no other profile is specified by the user.</p>
</div>
<div class="paragraph">
<p>To enable a specific profile use -profile option followed by the profile name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run &lt;your script&gt; -profile cluster</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Two or more configuration profiles can be specified by separating the profile names with a comma character:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">nextflow run &lt;your script&gt; -profile standard,cloud</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cloud_deployment">10.4. Cloud deployment</h3>
<div class="paragraph">
<p><a href="https://aws.amazon.com/batch/">AWS Batch</a> is a managed computing service that allows the execution of containerised workloads in the Amazon cloud infrastructure.</p>
</div>
<div class="paragraph">
<p>Nextflow provides a built-in support for AWS Batch which allows the seamless deployment of a Nextflow pipeline in the cloud offloading the process executions as Batch jobs.</p>
</div>
<div class="paragraph">
<p>Once the Batch environment is configured specifying the instance types to be used and the max number of cpus to be allocated, you need to created a Nextflow configuration file like the one showed below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process.executor = 'awsbatch'      <i class="conum" data-value="1"></i><b>(1)</b>
process.queue = 'cbcrg'      <i class="conum" data-value="2"></i><b>(2)</b>
process.container = 'nextflow/rnaseq-nf:latest'        <i class="conum" data-value="3"></i><b>(3)</b>
workDir = 's3://cbcrg/work/' <i class="conum" data-value="4"></i><b>(4)</b>
aws.region = 'eu-west-1'           <i class="conum" data-value="5"></i><b>(5)</b>
aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws' <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the AWS Batch as the executor to run the processes in the workflow</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the computing queue defined in the Batch environment
&lt;3&gt;The Docker container image to be used to run each job
&lt;4&gt;The workflow work directory must be a AWS S3 bucket
&lt;5&gt;The AWS region to be used
&lt;6&gt;The path of the AWS cli tool required to download/upload files to/from the container</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The best practices is to keep this setting as a separate profile in your workflow config file. This allows the execution with a simple command.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run script7.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete details about AWS Batch deployment are available at <a href="https://www.nextflow.io/docs/latest/awscloud.html#aws-batch">this link</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_volume_mounts">10.5. Volume mounts</h3>
<div class="paragraph">
<p>EBS volumes (or other supported storage) can be mounted in the job container using the following configuration snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">aws {
  batch {
      volumes = '/some/path'
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple volumes can be specified using comma-separated paths. The usual Docker volume mount syntax can be used to define complex volumes for which the container paths is different from the host paths or to specify a read-only option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">aws {
  region = 'eu-west-1'
  batch {
      volumes = ['/tmp', '/host/path:/mnt/path:ro']
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>IMPORTANT:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This is a global configuration that has to be specified in a Nextflow config file, as such it’s applied to <strong>all</strong> process executions.</p>
</li>
<li>
<p>Nextflow expects those paths to be available. It does not handle the provision of EBS volumes or other kind of storage.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_custom_job_definition">10.6. Custom job definition</h3>
<div class="paragraph">
<p>Nextflow automatically creates the Batch <a href="https://docs.aws.amazon.com/batch/latest/userguide/job_definitions.html">Job definitions</a> needed to execute your pipeline processes. Therefore it’s not required to define them before run your workflow.</p>
</div>
<div class="paragraph">
<p>However, you may still need to specify a custom Job Definition to provide fine-grained control of the configuration settings of a specific job e.g. to define custom mount paths or other special settings of a Batch Job.</p>
</div>
<div class="paragraph">
<p>To use your own job definition in a Nextflow workflow, use it in place of the container image name, prefixing it with the <code>job-definition://</code> string. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    container = 'job-definition://your-job-definition-name'
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_custom_image">10.7. Custom image</h3>
<div class="paragraph">
<p>Since Nextflow requires the AWS CLI tool to be accessible in the computing environment a common solution consists of creating a custom AMI and install it in a self-contained manner e.g. using Conda package manager.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When creating your custom AMI for AWS Batch, make sure to use the <em>Amazon ECS-Optimized Amazon Linux AMI</em> as the base image.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following snippet shows how to install AWS CLI with Miniconda:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo yum install -y bzip2 wget
wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -f -p $HOME/miniconda
$HOME/miniconda/bin/conda install -c conda-forge -y awscli
rm Miniconda3-latest-Linux-x86_64.sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>aws</code> tool will be placed in a directory named bin in the main installation folder. Modifying this directory structure, after the installation, this will cause the tool not to work properly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally specify the <code>aws</code> full path in the Nextflow config file as show below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_launch_template">10.8. Launch template</h3>
<div class="paragraph">
<p>An alternative to is to create a custom AMI using a Launch template that installs the AWS CLI tool during the instance boot via a custom user-data.</p>
</div>
<div class="paragraph">
<p>In the EC2 dashboard create a <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-launch-templates.html">Launch template</a> specifying in the user data field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="//"

--//
Content-Type: text/x-shellscript; charset="us-ascii"

#!/bin/sh
## install required deps
set -x
export PATH=/usr/local/bin:$PATH
yum install -y jq python27-pip sed wget bzip2
pip install -U boto3

## install awscli
USER=/home/ec2-user
wget -q https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -f -p $USER/miniconda
$USER/miniconda/bin/conda install -c conda-forge -y awscli
rm Miniconda3-latest-Linux-x86_64.sh
chown -R ec2-user:ec2-user $USER/miniconda

--//--</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then in the Batch dashboard create a new compute environment and specify the newly created launch template in the corresponding field.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hybrid_deployments">10.9. Hybrid deployments</h3>
<div class="paragraph">
<p>Nextflow allows the use of multiple executors in the same workflow application. This feature enables the deployment of hybrid workloads in
which some jobs are execute in the local computer or local computing cluster and some jobs are offloaded to AWS Batch service.</p>
</div>
<div class="paragraph">
<p>To enable this feature use one or more <a href="https://www.nextflow.io/docs/latest/config.html#config-process-selectors">process selectors</a> in
your Nextflow configuration file to apply the <a href="https://www.nextflow.io/docs/latest/awscloud.html#awscloud-batch-config">AWS Batch configuration</a>
only to a subset of processes in your workflow. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">process {
    executor = 'slurm' <i class="conum" data-value="1"></i><b>(1)</b>
    queue = 'short'    <i class="conum" data-value="2"></i><b>(2)</b>

    withLabel: bigTask {         <i class="conum" data-value="3"></i><b>(3)</b>
      executor = 'awsbatch'      <i class="conum" data-value="4"></i><b>(4)</b>
      queue = 'my-batch-queue'   <i class="conum" data-value="5"></i><b>(5)</b>
      container = 'my/image:tag' <i class="conum" data-value="6"></i><b>(6)</b>
  }
}

aws {
    region = 'eu-west-1' <i class="conum" data-value="7"></i><b>(7)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set slurm as the default executor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the queue for the SLURM cluster</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Setting of for the process named bigTask</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set awsbatch as executor for the bigTask process</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the queue for the for the bigTask process</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>set the container image to deploy the bigTask process</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Defines the region for Batch execution</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_execution_cache_and_resume">11. Execution cache and resume</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nextflow caching mechanism works assigning a unique ID to each task which is used to create a separate execution directory where the tasks are executed and the results stored.</p>
</div>
<div class="paragraph">
<p>The task unique ID is generated as a 128-bit hash number obtained composing the task inputs values and files and the command string.</p>
</div>
<div class="paragraph">
<p>The pipeline work directory is organized as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>work/
├── 12
│   └── 1adacb582d2198cd32db0e6f808bce
│       ├── genome.fa -&gt; /data/../genome.fa
│       └── index
│           ├── hash.bin
│           ├── header.json
│           ├── indexing.log
│           ├── quasi_index.log
│           ├── refInfo.json
│           ├── rsd.bin
│           ├── sa.bin
│           ├── txpInfo.bin
│           └── versionInfo.json
├── 19
│   └── 663679d1d87bfeafacf30c1deaf81b
│       ├── ggal_gut
│       │   ├── aux_info
│       │   │   ├── ambig_info.tsv
│       │   │   ├── expected_bias.gz
│       │   │   ├── fld.gz
│       │   │   ├── meta_info.json
│       │   │   ├── observed_bias.gz
│       │   │   └── observed_bias_3p.gz
│       │   ├── cmd_info.json
│       │   ├── libParams
│       │   │   └── flenDist.txt
│       │   ├── lib_format_counts.json
│       │   ├── logs
│       │   │   └── salmon_quant.log
│       │   └── quant.sf
│       ├── ggal_gut_1.fq -&gt; /data/../ggal_gut_1.fq
│       ├── ggal_gut_2.fq -&gt; /data/../ggal_gut_2.fq
│       └── index -&gt; /data/../asciidocs/day2/work/12/1adacb582d2198cd32db0e6f808bce/index</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_resume_works">11.1. How to resume works</h3>
<div class="paragraph">
<p>The <code>-resume</code> command line option allow the continuation of a pipeline execution since the last step that was successfully completed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run &lt;script&gt; -resume</code></pre>
</div>
</div>
<div class="paragraph">
<p>In practical terms the pipeline is executed from the beginning however before launching the execution of a process. Nextflow uses the task unique ID to check if the work directory already exists and it contains a valid command exit status and the expected output files.</p>
</div>
<div class="paragraph">
<p>If this condition is satisfied the task execution is skipped and previously computed results are used as the process results.</p>
</div>
<div class="paragraph">
<p>The first task, for which a new output is computed, invalidates all downstream executions in the remaining DAG.</p>
</div>
</div>
<div class="sect2">
<h3 id="_work_directory">11.2. Work directory</h3>
<div class="paragraph">
<p>The task work directories are created in the folder <code>work</code> in the launching path by default. This is supposed to be a <strong>scratch</strong> storage area that can be cleaned up once the computation is completed.</p>
</div>
<div class="paragraph">
<p>Workflow final output are supposed to the stored in a different location specified using one or more <a href="https://www.nextflow.io/docs/latest/process.html#publishdir">publishDir</a> directive.</p>
</div>
<div class="paragraph">
<p>A different location for the execution work directory can be specified using the command line option <code>-w</code> e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run &lt;script&gt; -w /some/scratch/dir</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you delete or move the pipeline work directory will prevent to use the resume feature in following runs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The hash code for input files is computed using:</p>
</div>
<div class="paragraph">
<p>The complete file path</p>
</div>
<div class="paragraph">
<p>The file size</p>
</div>
<div class="paragraph">
<p>The last modified timestamp</p>
</div>
<div class="paragraph">
<p>Therefore just <strong>touching</strong> a file will invalidated the related task execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_organize_in_silico_experiments">11.3. How to organize in silico experiments</h3>
<div class="paragraph">
<p>It’s a good practice to organize each <strong>experiment</strong> in its own folder. The experiment main input parameters should be specified using a Nextflow config file.
This makes simply to track and replicate the experiment over time.</p>
</div>
<div class="paragraph">
<p>Note that in the same experiment the same pipeline can be executed multiple times, however it should be avoided to launch two (or more) Nextflow instances
in the same directory concurrently.</p>
</div>
<div class="paragraph">
<p>The nextflow log command lists the executions run in the current folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">$ nextflow log
TIMESTAMP          	DURATION	RUN NAME             	STATUS	REVISION ID	SESSION ID                          	COMMAND
2020-11-10 22:32:33	1.6s    	friendly_raman       	OK    	96eb04d6a4 	2b90bac5-5124-4933-a345-afb28ca4b184	nextflow run hello
2020-11-10 22:35:39	33s     	condescending_fourier	OK    	708cf52a33 	a8d1ece2-a6cb-493f-b54e-dac7266d2669	nextflow run rnaseq-nf -with-docker
2020-11-10 22:55:30	1.7s    	insane_swanson       	ERR   	708cf52a33 	cc03a378-b524-4cb1-a100-6751dfe2c0b3	nextflow run rnaseq-nf
2020-11-10 22:55:50	25.9s   	focused_mccarthy     	OK    	708cf52a33 	cc03a378-b524-4cb1-a100-6751dfe2c0b3	nextflow run rnaseq-nf -resume -with-docker</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use either the <strong>session ID</strong> or the <strong>run name</strong> to recover a specific execution. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run rnaseq-nf -resume condescending_fourier -with-docker</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_execution_provenance">11.4. Execution provenance</h3>
<div class="paragraph">
<p>The <code>log</code> command when provided with a <strong>run name</strong> or <strong>session ID</strong> can return many useful information about a pipeline execution that can be used to create a
provenance report.</p>
</div>
<div class="paragraph">
<p>By default, it lists the work directories used to compute each task. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ nextflow log condescending_fourier

/data/.../work/e0/3192ad7ddc661e3054de66572cf6f9
/data/.../work/08/e7f13a32ccc0b2b1fe0c00bce4bd14
/data/.../work/5e/6dd708bf0e49ccba397d7b629af0e9
/data/.../work/51/1ae924e73bdd8ee91a660ca669fc4d
/data/.../work/5a/1b1ac5e340852e6bb4c2c919504025
/data/.../work/a9/784d05293b429146d2b5a43b352899</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the option <code>-f</code> (fields) it’s possible to specify which metadata should be printed by the <code>log</code> command. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ nextflow log condescending_fourier -f 'process,exit,hash,duration'

RNASEQ:FASTQC	0	e0/3192ad	21.2s
RNASEQ:FASTQC	0	08/e7f13a	21.1s
RNASEQ:INDEX	0	5e/6dd708	6.6s
RNASEQ:QUANT	0	51/1ae924	4.1s
RNASEQ:QUANT	0	5a/1b1ac5	3.9s
MULTIQC	0	a9/784d05	10s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete list of available fields can be retrieved with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow log -l</code></pre>
</div>
</div>
<div class="paragraph">
<p>The option <code>-F</code> allows the specification of a filtering criteria to print only a subset of tasks. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ nextflow log condescending_fourier -F 'process =~ /RNASEQ:FASTQC/'

/data/.../work/e0/3192ad7ddc661e3054de66572cf6f9
/data/.../work/08/e7f13a32ccc0b2b1fe0c00bce4bd14</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful to locate specific tasks work directories.</p>
</div>
<div class="paragraph">
<p>Finally, the <code>-t</code> option allow the creation of a basic custom provenance report proving a template file, in any format of your choice. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;div&gt;
&lt;h2&gt;${name}&lt;/h2&gt;
&lt;div&gt;
Script:
&lt;pre&gt;${script}&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
    &lt;li&gt;Exit: ${exit}&lt;/li&gt;
    &lt;li&gt;Status: ${status}&lt;/li&gt;
    &lt;li&gt;Work dir: ${workdir}&lt;/li&gt;
    &lt;li&gt;Container: ${container}&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the above snippet in a file named <code>template.html</code>. Then run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow log condescending_fourier -t template.html &gt; prov.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally open the file <code>prov.html</code> file with a browser.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resume_troubleshooting">11.5. Resume troubleshooting</h3>
<div class="paragraph">
<p>If your workflow execution is not resumed as expected and one or more task are re-executed all the times, these may be the most likely causes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Input file changed</strong>: Make sure that there’s no change in your input files. Don’t forget task unique hash is computed taking into account the complete file path, the last modified timestamp and the file size.
If any of these information changes, the workflow will be re-executed even if the input content is the same.</p>
</li>
<li>
<p><strong>A process modifies an input</strong>: A process should never alter input files otherwise the resume, for future executions, will be invalidated for the same reason explained in the previous point.</p>
</li>
<li>
<p><strong>Inconsistent file attributes</strong>: Some shared file system, such as <a href="https://en.wikipedia.org/wiki/Network_File_System">NFS</a>, may report inconsistent
file timestamp i.e. a different timestamp for the same file even if it has not be modified. To prevent this
problem use the <a href="https://www.nextflow.io/docs/latest/process.html#cache">lenient cache strategy</a>.</p>
</li>
<li>
<p><strong>Race condition in global variable</strong>: Nextflow is designed to simplify parallel programming without taking care about race conditions and the access to shared resources. One of the few cases in which a race condition can arise is when using a global variable with two (or more) operators. For example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .from(1,2,3)
    .map { it -&gt; X=it; X+=2 }
    .view { "ch1 = $it" }

Channel
    .from(1,2,3)
    .map { it -&gt; X=it; X*=2 }
    .view { "ch2 = $it" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem in this snippet is that the <code>X</code> variable in the closure definition is defined in the global scope. Therefore, since operators are executed
in parallel, the <code>X</code> value can be overwritten by the other <code>map</code> invocation.</p>
</div>
<div class="paragraph">
<p>The correct implementation requires the use of the def keyword to declare the variable <strong>local</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">Channel
    .from(1,2,3)
    .map { it -&gt; def X=it; X+=2 }
    .println { "ch1 = $it" }

Channel
    .from(1,2,3)
    .map { it -&gt; def X=it; X*=2 }
    .println { "ch2 = $it" }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Not deterministic input channels</strong>: While dataflow channel ordering is guaranteed i.e. data is read in the same order in which it’s written in the channel, when a process declares as input two or more channel each of which is the output of a different process the overall input ordering is not consistent over different executions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In practical term, consider the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  input: set val(pair), file(reads) from ...
  output: set val(pair), file('*.bam') into bam_ch
  """
  your_command --here
  """
}

process bar {
  input: set val(pair), file(reads) from ...
  output: set val(pair), file('*.bai') into bai_ch
  """
  other_command --here
  """
}

process gather {
  input:
  set val(pair), file(bam) from bam_ch
  set val(pair), file(bai) from bai_ch
  """
  merge_command $bam $bai
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The inputs declared at line 19,20 can be delivered in any order because the execution order of the process <code>foo</code> and <code>bar</code> is not deterministic due to the parallel
executions of them.</p>
</div>
<div class="paragraph">
<p>Therefore the input of the third process needs to be synchronized using the <a href="https://www.nextflow.io/docs/latest/operator.html#join">join</a> operator or a similar
approach. The third process should be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">...

process gather {
  input:
  set val(pair), file(bam), file(bai) from bam_ch.join(bai_ch)
  """
  merge_command $bam $bai
  """
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_errors_handling_troubleshooting">12. Errors handling &amp; troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_execution_errors_debugging">12.1. Execution errors debugging</h3>
<div class="paragraph">
<p>When a process execution exit with a non-zero exit status, Nextflow stops the workflow execution and report the failing task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>ERROR ~ Error executing process &gt; 'index'

Caused by:          <i class="conum" data-value="1"></i><b>(1)</b>
  Process `index` terminated with an error exit status (127)

Command executed:   <i class="conum" data-value="2"></i><b>(2)</b>

  salmon index --threads 1 -t transcriptome.fa -i index

Command exit status: <i class="conum" data-value="3"></i><b>(3)</b>
  127

Command output:      <i class="conum" data-value="4"></i><b>(4)</b>
  (empty)

Command error:       <i class="conum" data-value="5"></i><b>(5)</b>
  .command.sh: line 2: salmon: command not found

Work dir:            <i class="conum" data-value="6"></i><b>(6)</b>
  /Users/pditommaso/work/0b/b59f362980defd7376ee0a75b41f62</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A description of the error cause</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The command executed</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The command exit status</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The command standard output, when available</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The command standard error</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The command work directory</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Review carefully all these data, they can provide valuable information on the cause of the error.</p>
</div>
<div class="paragraph">
<p>If this is not enough, change in the task work directory. It contains all the files to replicate the issue in a isolated manner.</p>
</div>
<div class="paragraph">
<p>The task execution directory contains these files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.command.sh</code>: The command script.</p>
</li>
<li>
<p><code>.command.run</code>: The command wrapped used to run the job.</p>
</li>
<li>
<p><code>.command.out</code>: The complete job standard output.</p>
</li>
<li>
<p><code>.command.err</code>: The complete job standard error.</p>
</li>
<li>
<p><code>.command.log</code>: The wrapper execution output.</p>
</li>
<li>
<p><code>.command.begin</code>: Sentinel file created as soon as the job is launched.</p>
</li>
<li>
<p><code>.exitcode</code>: A file containing the task exit code.</p>
</li>
<li>
<p>Task input files (symlinks)</p>
</li>
<li>
<p>Task output files</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Verify that the <code>.command.sh</code> file contains the expected command to be executed and all variables are correctly resolved.</p>
</div>
<div class="paragraph">
<p>Also verify the existence of the file <code>.exitcode</code>. If missing and also the file <code>.command.begin</code> does not exist, the task was never
executed by the subsystem (eg. the batch scheduler). If the <code>.command.begin</code> file exist, the job was launched but the it likely was abruptly killed.</p>
</div>
<div class="paragraph">
<p>You can replicate the failing execution using the command bash <code>.command.run</code> and verify the cause of the error.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ignore_errors">12.2. Ignore errors</h3>
<div class="paragraph">
<p>There are cases in which a process error may be expected and it should not stop the overall workflow execution.</p>
</div>
<div class="paragraph">
<p>To handle this use case set the process <code>errorStrategy</code> to <code>ignore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  errorStrategy 'ignore'
  script:
  """
    your_command --this --that
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to ignore any error set the same directive in the config file as default setting:</p>
</div>
<div class="paragraph">
<p>process.errorStrategy = 'ignore'</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config">nextflow run rnaseq-nf</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_error_fail_over">12.3. Automatic error fail-over</h3>
<div class="paragraph">
<p>In (rare) cases errors may be caused by transient conditions. In this situation an effective strategy consists in trying to re-execute the failing task.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  errorStrategy 'retry'
  script:
  """
    your_command --this --that
  """
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>retry</code> error strategy the task is re-executed a second time if it returns a non-zero exit status before stopping the complete workflow execution.</p>
</div>
<div class="paragraph">
<p>The directive <a href="https://www.nextflow.io/docs/latest/process.html#maxretries">maxRetries</a> can be used to set number of attempts the task can be re-execute before declaring it failed with an error condition.</p>
</div>
</div>
<div class="sect2">
<h3 id="_retry_with_backoff">12.4. Retry with backoff</h3>
<div class="paragraph">
<p>There are cases in which the required execution resources may be temporary unavailable e.g. network congestion. In these cases simply re-executing the same task will likely result in the identical error. A retry with an exponential backoff delay can better recover these error conditions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  errorStrategy { sleep(Math.pow(2, task.attempt) * 200 as long); return 'retry' }
  maxRetries 5
  script:
  '''
  your_command --here
  '''
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_resources_allocation">12.5. Dynamic resources allocation</h3>
<div class="paragraph">
<p>It’s a very common scenario that different instances of the same process may have very different needs in terms of computing resources. In such situations requesting, for example, an amount of memory too low will cause some tasks to fail. Instead, using a higher limit that fits all the tasks in your execution could significantly decrease the execution priority of your jobs.</p>
</div>
<div class="paragraph">
<p>To handle this use case you can use a retry error strategy and increasing the computing resources allocated by the job at each successive attempt.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">process foo {
  cpus 4
  memory { 2.GB * task.attempt }  <i class="conum" data-value="1"></i><b>(1)</b>
  time { 1.hour * task.attempt }  <i class="conum" data-value="2"></i><b>(2)</b>
  errorStrategy { task.exitStatus == 140 ? 'retry' : 'terminate' }    <i class="conum" data-value="3"></i><b>(3)</b>
  maxRetries 3   <i class="conum" data-value="4"></i><b>(4)</b>

  script:
  """
    your_command --cpus $task.cpus --mem $task.memory
  """
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The memory is defined in a dynamic manner, the first attempt is 2 GB, the second 4 GB, and so on.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The wall execution time is set dynamically as well, the first execution attempt is set to 1 hour, the second 2 hours, and so on.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the task return an exit status equals to 140 sets the error strategy to retry otherwise terminates the execution.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>It can retry the process execution up to three times.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
    <div id="footer-text">
        Creative Commons CC BY-NC-ND (Attribution-NonCommercial-ShareAlike-NoDerivatives) <span class="image right CC BY-NC-ND"><img src="assets/by-nc-nd.png" alt="CC BY-NC-ND" height="30" width="120"></span>
    </div>
    <div id="footer-text">
        Copyright 2020, <a href="https://www.seqera.io">Seqera Labs</a>. All rights reserved. Not for redistribution.
    </div>
</div>
</body>
</html>